<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEDIDOS FAVU COZINHA AFETIVA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* CORRE√á√ÉO CR√çTICA DA FONTE */
        /* ========================================================================= */
        @font-face {
            font-family: 'Basic Choice 2';
            /* ‚ö†Ô∏è AJUSTE O CAMINHO DA FONTE SE NECESS√ÅRIO */
            src: url('fonts/Basic Choice 2.ttf') format('truetype'),
                local('Roboto'); 
            font-weight: normal;
            font-style: normal;
        }

        /* ========================================================================= */
        /* ESTILOS BASE, CORES E FORMATA√á√ÉO DE CAMPOS (PADR√ÉO FAVU) */
        /* ========================================================================= */
        body {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            background-color: #7FB1C8; /* Azul */
            margin: 0;
            padding: 0;
            color: #1A2B0F; /* Texto Escuro */
        }
        header {
            background-color: #F4E6CB; /* Creme */
            color: #1A2B0F;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-wrap: wrap; 
        }
        h1 { font-size: 24px; margin: 0; }
        
        /* Controles de Filtro e Bot√µes (Estilo Arredondado) */
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        .controls label, .controls button, .controls input {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            padding: 8px 10px;
            border-radius: 20px; /* Mais arredondado */
            font-size: 14px;
            border: 1px solid #E09F41;
            background-color: #F4E6CB;
            color: #1A2B0F;
            cursor: pointer;
        }
        .controls input[type="month"] { 
            border-radius: 10px; /* Padr√£o 10px para inputs de data/n√∫mero */
            width: 150px; 
            text-align: center; 
            appearance: none; -webkit-appearance: none; -moz-appearance: none; 
        }
        
        #refresh-button { 
            background-color: #E09F41; /* Laranja */
            color: white; 
            box-shadow: 0 4px #c2883a;
            border-radius: 20px; 
        }
        #refresh-button:active { box-shadow: 0 2px #c2883a; transform: translateY(2px); }

        #dashboard-totals { text-align: right; line-height: 1.2; padding-right: 15px; order: 1; }
        #dashboard-totals strong { display: block; font-size: 1.5em; color: #E09F41; }
        #dashboard-totals span { font-size: 0.8em; color: #555; }
        
        .filter-bar {
            background-color: #F4E6CB; 
            padding: 10px 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* ========================================================================= */
        /* ESTILOS KANBAN E RESPONSIVIDADE */
        /* ========================================================================= */
        #kanban-board {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            min-height: 80vh;
        }
        .kanban-column {
            flex-basis: 300px; 
            flex-shrink: 0;
            background-color: #F4E6CB;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            min-height: 70vh;
        }
        .column-header {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #E09F41; 
            text-align: center;
            color: #1A2B0F;
        }
        
        /* Estilos Mobile */
        @media (max-width: 768px) {
            header { flex-direction: column; align-items: flex-start; padding-bottom: 10px; }
            h1 { width: 100%; text-align: center; margin-bottom: 10px; }
            .controls { justify-content: space-around; width: 100%; margin-bottom: 10px; }
            .filter-bar { flex-direction: column; align-items: flex-start; padding: 10px; }
            .filter-bar > * { width: 100%; margin-top: 5px; }
            #dashboard-totals { text-align: center; width: 100%; padding-right: 0; margin-bottom: 10px; }
            #kanban-board { padding: 10px; gap: 10px; }
            .kanban-column { flex-basis: 80vw; min-height: 80vh; }
        }

        /* Cores de Status */
        .pedido-card { background-color: white; border: 1px solid #ddd; border-left: 5px solid #7FB1C8; border-radius: 6px; padding: 10px; margin-bottom: 10px; cursor: pointer; color: #1A2B0F; }
        .status-Aberto { border-left-color: #17a2b8; } 
        .status-Or√ßado { border-left-color: #E09F41; } 
        .status-Agendado-50- { border-left-color: #1abc9c; } 
        .status-Agendado-100- { border-left-color: #2ecc71; } 
        .status-Entregue-Pendente { border-left-color: #7FB1C8; opacity: 0.8; } 
        .status-Entregue { border-left-color: #7FB1C8; opacity: 0.8; } 
        .status-Entregue-Pago { border-left-color: #1A2B0F; opacity: 0.7; } 
        .status-Cancelado { border-left-color: #E60000; opacity: 0.6; } 
        
        /* Estilos do Modal */
        .modal { 
            /* üö® CORRE√á√ÉO CR√çTICA: display: none como padr√£o */
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            /* Propriedades de centraliza√ß√£o aplicadas quando o JS define display: flex */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content { 
            background-color: #F4E6CB; 
            border-radius: 10px; 
            padding: 25px; 
            max-width: 650px; 
            width: 90%;
            position: relative; 
            margin: auto; /* Garante compatibilidade de centraliza√ß√£o */
        }
        .close-button { color: #E09F41; float: right; font-size: 30px; font-weight: bold; position: absolute; top: 10px; right: 20px; }
        #modal-details strong { color: #7FB1C8; }
        #modal-details pre { white-space: pre-wrap; background-color: white; padding: 10px; border-radius: 4px; border: 1px solid #7FB1C8; color: #1A2B0F; }
        
        /* Inputs e Bot√µes de Edi√ß√£o (Estilo Favou) */
        #edit-form input, #edit-form textarea, #edit-form select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #7FB1C8; 
            border-radius: 10px; 
            background-color: white;
            color: #1A2B0F;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
        }
        #edit-form textarea[readonly] {
             background-color: #eee; /* Cor de fundo para campo n√£o edit√°vel */
             cursor: not-allowed;
        }
        .modal-actions button, #edit-form button {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            padding: 12px 20px;
            margin-top: 15px;
            border: none;
            border-radius: 20px; 
            cursor: pointer;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px #4c7e93; 
        }
        #edit-form button:active { box-shadow: 0 2px #4c7e93; transform: translateY(2px); }

        /* Cores dos Bot√µes de A√ß√£o */
        #edit-button, #edit-form button[type="submit"] { background-color: #2ecc71; box-shadow: 0 4px #1c8d50; } 
        #delete-button { background-color: #E60000; box-shadow: 0 4px #a00000; } 
        #cancel-edit { background-color: #E09F41; box-shadow: 0 4px #c2883a; } 
        #open-calculator-button { background-color: #7FB1C8; box-shadow: 0 4px #4c7e93; margin-right: 10px; margin-bottom: 10px; border-radius: 20px; }
        
        #resumo-editor-section { padding: 10px; background-color: #F4E6CB; border-radius: 8px; margin-top: 10px; border: 1px solid #7FB1C8; }
        #calculator-modal { 
            background-color: rgba(0,0,0,0.8); 
            z-index: 1100; 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            justify-content: center; 
            align-items: center; 
        }
        #calculator-iframe { width: 95%; height: 95%; border: 5px solid #E09F41; border-radius: 15px; background-color: white; }

    </style>
</head>
<body>

    <header>
        <h1>PEDIDOS FAVU COZINHA AFETIVA</h1>
        <div class="controls">
             <div id="dashboard-totals">
                 <strong>R$ 0,00</strong>
                 <span id="total-pedidos">0 pedidos</span>
             </div>
        </div>
    </header>

    <div class="filter-bar">
        <button id="refresh-button">Recarregar</button>
        <label for="month-filter">M√™s/Ano de Entrega:</label>
        <input type="month" id="month-filter" value="">
    </div>

    <main id="kanban-board">
    </main>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Detalhes do Pedido <span id="pedido-id"></span></h2>
            
            <div id="modal-details">
                <p><strong>Status:</strong> <span id="detail-status"></span></p>
                <p><strong>Cliente:</strong> <span id="detail-nome"></span></p>
                <p><strong>Data/Hora de Entrega:</strong> <span id="detail-data-hora"></span></p>
                <p><strong>Forma de Pagamento:</strong> <span id="detail-pagamento"></span></p>
                <p><strong>Total Final:</strong> <span id="detail-total-final"></span></p>
                <strong>Resumo dos Itens:</strong> 
                <pre id="detail-resumo-itens"></pre>
            </div>

            <div class="modal-actions">
                <button id="edit-button">Editar Pedido</button>
                <button id="delete-button" class="danger">Excluir Pedido</button>
            </div>

            <form id="edit-form" style="display: none;">
                <h3>Editar Dados do Pedido</h3>
                
                <label for="edit-status">Status do Pedido:</label>
                <select id="edit-status" name="status" required>
                    </select><br>
                
                <label>Nome do Cliente:</label>
                <input type="text" id="edit-nome" required><br>
                
                <label>Data de Entrega (DD/MM/AAAA):</label>
                <input type="text" id="edit-data" required placeholder="DD/MM/AAAA"><br> 
                
                <label>Hor√°rio de Entrega (HH:MM):</label>
                <input type="time" id="edit-horario" required><br>
                
                <label for="edit-pagamento">Forma de Pagamento:</label>
                <select id="edit-pagamento" name="pagamento" required>
                    <option value="Pix">Pix</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Cart√£o">Cart√£o</option>
                </select><br>

                <label>Total Final (R$):</label>
                <input type="number" step="0.01" id="edit-total" required><br>

                <label>Resumo dos Itens (N√ÉO EDIT√ÅVEL):</label>
                <div id="resumo-editor-section">
                    <button type="button" id="open-calculator-button" onclick="openCalculatorModal()">Gerar Resumo por Itens</button>
                    <textarea id="edit-resumo" rows="8" readonly required></textarea> 
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex-grow: 1;">Salvar Edi√ß√£o</button>
                    <button type="button" id="cancel-edit" style="flex-grow: 1;">Cancelar Edi√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="calculator-modal" class="modal" onclick="closeCalculatorModal(event)">
        <div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
             <iframe id="calculator-iframe" src="" frameborder="0"></iframe>
        </div>
    </div>


    <script>
        // =========================================================================
        // JAVASCRIPT (L√ìGICA)
        // =========================================================================

        const API_URL = 'https://script.google.com/macros/s/AKfycbzPg0luc_LKOhkOLrefXv202qDAHMHFHO_19WF4dtXoc_20MwykJzNI5IRuYlq0Rr5s/exec'; 
        const CALCULATOR_URL = 'https://favucozinha.github.io/Calculadora-Favu/'; 

        // ARRAY FINAL DE STATUS
        const KANBAN_STATUSES = [
            'Aberto',
            'Or√ßado',
            'Agendado - 50%',
            'Agendado - 100%',
            'Entregue', 
            'Entregue - Pendente',
            'Entregue - Pago',
            'Cancelado'
        ];

        let todosOsPedidos = [];
        let pedidoSendoEditado = null;
        
        // =========================================================================
        // FUN√á√ïES DE UTILIDADE E CORRE√á√ÉO DE DATA/HORA
        // =========================================================================

        /**
         * Retorna a data no formato DD/MM/YYYY.
         */
        function formatDate(dateString) {
            if (dateString && typeof dateString === 'string') {
                const match = dateString.match(/(\d{2}\/\d{2}\/\d{4})/);
                if (match) return match[0];
            }
            return 'N/A';
        }
        
        /**
         * Retorna a hora no formato HH:MM.
         */
        function formatTime(timeValue) {
             if (!timeValue) return 'N/A';
             const timeString = String(timeValue);
             const match = timeString.match(/(\d{1,2}:\d{2})/);
             if (match) {
                 let [h, m] = match[0].split(':');
                 return `${h.padStart(2, '0')}:${m}`;
             }
             return 'N/A';
        }

        /**
         * Converte string DD/MM/AAAA para YYYY-MM-DD (para fins de filtro e Date Object).
         */
        function formatDDMMYYYYtoYYYYMMDD(dateString) {
            if (!dateString) return null;
            const parts = String(dateString).split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return null;
        }

        /**
         * Extrai apenas a lista de itens do resumo de texto longo (Coluna J).
         */
        function extractResumoItens(fullResumo) {
            if (!fullResumo) return 'N/A';
            
            const startKey = '- Resumo do pedido:';
            const endKey = 'Total Final:';
            
            const startIndex = fullResumo.indexOf(startKey);
            const endIndex = fullResumo.indexOf(endKey);

            if (startIndex !== -1) {
                let resumo = fullResumo.substring(startIndex + startKey.length).trim();
                
                if (endIndex !== -1 && endIndex > startIndex) {
                    resumo = fullResumo.substring(startIndex + startKey.length, endIndex).trim();
                }
                
                return resumo.replace(/^\s*\n/g, '').replace(/\n\s*$/g, '');
            }

            return fullResumo;
        }
        
        // =========================================================================
        // FUN√á√ïES DE COMUNICA√á√ÉO E RENDERIZA√á√ÉO
        // =========================================================================

        async function fetchPedidos() {
            document.getElementById('refresh-button').textContent = 'Carregando...';
            document.getElementById('refresh-button').disabled = true;
            document.getElementById('total-pedidos').textContent = '...';

            try {
                const response = await fetch(`${API_URL}?action=read`);
                const json = await response.json();

                if (json.success) {
                    
                    todosOsPedidos = json.pedidos.map(p => {
                        let dataAPI = String(p.Data_da_Entrega || ''); // DD/MM/YYYY
                        let horarioAPI = String(p.Hor√°rio_da_Entrega || '00:00'); // HH:MM

                        // Converte DD/MM/AAAA para YYYY-MM-DD para o filtro e input HTML
                        let dataParaInput = formatDDMMYYYYtoYYYYMMDD(dataAPI);
                        
                        let sortDate = new Date(0); 
                        
                        // Cria um Date Object para ordena√ß√£o
                        if (dataParaInput) {
                           try {
                                sortDate = new Date(`${dataParaInput.replace(/-/g, '/')} ${formatTime(horarioAPI)}`);
                           } catch(e) {
                                sortDate = new Date(0);
                           }
                        }
                        
                        return {
                            ...p,
                            Data_para_Input: dataParaInput, // YYYY-MM-DD (para filtro)
                            Hor√°rio_da_Entrega: horarioAPI, 
                            sortDate: sortDate 
                        };
                    }).filter(p => p.ID_do_Pedido); 
                    
                    todosOsPedidos.sort((a, b) => a.sortDate - b.sortDate);

                    renderKanban();
                    // updateDashboardTotals √© chamado dentro de renderKanban
                } else {
                    console.error("Erro ao buscar pedidos:", json.message);
                    alert("Erro ao carregar os pedidos: " + json.message);
                }
            } catch (error) {
                console.error("Erro na comunica√ß√£o com a API (Network/Parsing):", error);
                alert("Erro de rede ao carregar os pedidos. Verifique o console para detalhes.");
            } finally {
                document.getElementById('refresh-button').textContent = 'Recarregar';
                document.getElementById('refresh-button').disabled = false;
            }
        }

        /**
         * Fun√ß√£o para renderizar o quadro Kanban e os cards
         */
        function renderKanban() {
            const kanbanBoard = document.getElementById('kanban-board');
            kanbanBoard.innerHTML = '';
            
            const monthFilterInput = document.getElementById('month-filter').value;
            
            const filterYear = monthFilterInput ? monthFilterInput.substring(0, 4) : null;
            const filterMonth = monthFilterInput ? monthFilterInput.substring(5, 7) : null; 
            
            // Vari√°vel para calcular totais APENAS dos pedidos vis√≠veis
            let pedidosVisiveis = [];

            KANBAN_STATUSES.forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.status = status; 
                column.addEventListener('dragover', dragOver);
                column.addEventListener('drop', drop);
                column.addEventListener('dragleave', dragLeave);

                const header = document.createElement('div');
                header.className = 'column-header';
                
                let filteredPedidos = todosOsPedidos.filter(p => p.Status === status);

                // =============================================================
                // L√ìGICA DE FILTRO BASEADA NA DATA DE ENTREGA (COLUNA C)
                // =============================================================
                let pedidosFiltradosPorData = filteredPedidos;

                if (filterMonth && filterYear) {
                    pedidosFiltradosPorData = filteredPedidos.filter(p => {
                        const dateInput = String(p.Data_para_Input); // Espera YYYY-MM-DD
                        
                        if (dateInput && dateInput.length === 10 && dateInput !== 'N/A') {
                             const pYear = dateInput.substring(0, 4);
                             const pMonth = dateInput.substring(5, 7);
                             
                             return pMonth === filterMonth && pYear === filterYear;
                        }
                        return false; 
                    });
                }
                // FIM DA L√ìGICA DE FILTRO

                // Adiciona pedidos vis√≠veis √† lista para c√°lculo do dashboard
                pedidosVisiveis.push(...pedidosFiltradosPorData);
                
                header.textContent = `${status} (${pedidosFiltradosPorData.length})`;
                column.appendChild(header);

                pedidosFiltradosPorData.forEach(pedido => {
                    const card = createPedidoCard(pedido);
                    column.appendChild(card);
                });

                kanbanBoard.appendChild(column);
            });
            
            // Chama a fun√ß√£o de totais passando apenas os pedidos vis√≠veis.
            updateDashboardTotals(pedidosVisiveis); 
        }
        
        /**
         * Recebe apenas a lista de pedidos VIS√çVEIS (filtrados).
         */
        function updateDashboardTotals(pedidosVisiveis) {
            let totalLiquidoGeral = 0;
            let totalPedidosContados = 0;
            const statusToCount = ['Aberto', 'Or√ßado', 'Agendado - 50%', 'Agendado - 100%', 'Entregue', 'Entregue - Pendente', 'Entregue - Pago'];

            pedidosVisiveis.forEach(p => {
                 const total = parseFloat(p.Total_Final || 0); 
                 if (statusToCount.includes(p.Status)) {
                     totalLiquidoGeral += total;
                     totalPedidosContados++;
                 }
            });

            document.querySelector('#dashboard-totals strong').textContent = `R$ ${totalLiquidoGeral.toFixed(2).replace('.', ',')}`;
            document.getElementById('total-pedidos').textContent = `${totalPedidosContados} ${totalPedidosContados === 1 ? 'pedido' : 'pedidos'}`;
        }

        function createPedidoCard(pedido) {
            const card = document.createElement('div');
            const sanitizedStatus = pedido.Status.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').trim('-'); 

            card.className = `pedido-card status-${sanitizedStatus}`;
            card.setAttribute('draggable', true);
            card.dataset.id = pedido.ID_do_Pedido;

            const total = parseFloat(pedido.Total_Final || 0).toFixed(2).replace('.', ',');
            
            const data = pedido.Data_da_Entrega; // DD/MM/AAAA
            const hora = formatTime(pedido.Hor√°rio_da_Entrega); 
            const dataHora = `${data} √†s ${hora}`;

            card.innerHTML = `
                <div class="card-title">${pedido.Nome_do_Cliente}</div>
                <div class="card-detail">Entrega: ${dataHora}</div>
                <div class="card-detail">Total: R$ ${total}</div>
                <div class="card-detail" style="font-weight: bold;">ID: ${pedido.ID_do_Pedido}</div>
            `;

            card.addEventListener('dragstart', dragStart);
            // Corrige o conflito de clique/drag:
            card.addEventListener('click', (e) => {
                 e.stopPropagation(); 
                 showModal(pedido.ID_do_Pedido);
            }); 

            return card;
        }

        // =========================================================================
        // DRAG AND DROP E MODAL (L√ìGICA)
        // =========================================================================

        function dragStart(e) { e.dataTransfer.setData('text/plain', e.target.dataset.id); e.target.classList.add('dragging'); }
        function dragOver(e) { e.preventDefault(); const column = e.currentTarget; column.classList.add('over'); }
        function dragLeave(e) { e.currentTarget.classList.remove('over'); }
        
        async function drop(e) {
            e.preventDefault();
            const column = e.currentTarget;
            const newStatus = column.dataset.status;
            const pedidoId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.querySelector(`.dragging[data-id="${pedidoId}"]`);

            column.classList.remove('over');
            
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                column.appendChild(draggedCard);
            }
            
            await updatePedidoStatus(pedidoId, newStatus);
        }

        async function updatePedidoStatus(id, status) {
            const formData = new URLSearchParams();
            formData.append('action', 'updateStatus');
            formData.append('id', id);
            formData.append('status', status);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const json = await response.json();

                if (json.success) {
                    await fetchPedidos(); 
                } else {
                    alert(`Falha ao atualizar status: ${json.message}`);
                    await fetchPedidos(); 
                }
            } catch (error) {
                alert("Erro de rede ao tentar atualizar o status.");
                await fetchPedidos(); 
            }
        }
        
        // MODAL FUNCTIONS
        const modal = document.getElementById('modal');
        const editForm = document.getElementById('edit-form');

        function showModal(id) {
            
            const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === id);
            if (!pedido) {
                 console.error("Pedido n√£o encontrado para o ID:", id);
                 return;
            }

            pedidoSendoEditado = pedido; 
            
            // Exibi√ß√£o
            const totalNum = parseFloat(pedido.Total_Final || 0);
            const totalFormatado = totalNum.toFixed(2).replace('.', ',');
            
            const data = pedido.Data_da_Entrega;
            const hora = formatTime(pedido.Hor√°rio_da_Entrega);
            const dataHora = `${data} √†s ${hora}`;
            
            // Preenche o cabe√ßalho e detalhes
            document.getElementById('modal-title').innerHTML = `Detalhes do Pedido <span id="pedido-id">${id}</span>`;
            document.getElementById('detail-status').textContent = pedido.Status;
            document.getElementById('detail-nome').textContent = pedido.Nome_do_Cliente;
            document.getElementById('detail-data-hora').textContent = dataHora;
            document.getElementById('detail-pagamento').textContent = pedido.Forma_Pagamento;
            document.getElementById('detail-total-final').textContent = `R$ ${totalFormatado}`;
            document.getElementById('detail-resumo-itens').textContent = extractResumoItens(pedido.Resumo_dos_Itens);

            // Preenchimento para Edi√ß√£o
            const editStatusSelect = document.getElementById('edit-status');
            editStatusSelect.innerHTML = '';
            KANBAN_STATUSES.forEach(status => {
                 const option = document.createElement('option');
                 option.value = status;
                 option.textContent = status;
                 editStatusSelect.appendChild(option);
            });
            editStatusSelect.value = pedido.Status; 

            document.getElementById('edit-nome').value = pedido.Nome_do_Cliente;
            document.getElementById('edit-data').value = pedido.Data_da_Entrega; // DD/MM/AAAA
            document.getElementById('edit-horario').value = formatTime(pedido.Hor√°rio_da_Entrega); // HH:MM
            document.getElementById('edit-pagamento').value = pedido.Forma_Pagamento;
            document.getElementById('edit-total').value = totalNum.toFixed(2); 
            
            // O Resumo √© preenchido, mas √© readonly
            document.getElementById('edit-resumo').value = pedido.Resumo_dos_Itens;
            
            modal.style.display = 'flex'; // Torna o modal vis√≠vel
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        }

        function closeModal() {
            modal.style.display = 'none';
            pedidoSendoEditado = null;
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        }

        document.getElementById('edit-button').addEventListener('click', () => {
            document.getElementById('modal-details').style.display = 'none';
            document.querySelector('.modal-actions').style.display = 'none';
            editForm.style.display = 'block';
        });

        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        });
        
        // Adiciona o evento de submiss√£o do formul√°rio de edi√ß√£o
        editForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             await updatePedidoData();
        });


        function openCalculatorModal() {
            if (!CALCULATOR_URL) {
                 alert("URL do calculador n√£o configurada. Defina a constante CALCULATOR_URL no c√≥digo.");
                 return;
            }
            document.getElementById('calculator-iframe').src = CALCULATOR_URL;
            document.getElementById('calculator-modal').style.display = 'flex';
        }
        
        function closeCalculatorModal(event) {
             // Fecha apenas se o clique for no fundo do modal
             if (event.target.id === 'calculator-modal') {
                document.getElementById('calculator-iframe').src = '';
                document.getElementById('calculator-modal').style.display = 'none';
             }
        }
        
        async function updatePedidoData() {
            const formData = new URLSearchParams();
            formData.append('action', 'updateData');
            
            // Pega os dados do formul√°rio de edi√ß√£o
            const statusToSheet = document.getElementById('edit-status').value;
            const dataToSheet = document.getElementById('edit-data').value; // DD/MM/AAAA
            const horaToSheet = document.getElementById('edit-horario').value; // HH:MM
            const nomeToSheet = document.getElementById('edit-nome').value;
            const totalToSheet = document.getElementById('edit-total').value; 
            const pagamentoToSheet = document.getElementById('edit-pagamento').value;
            
            // O Resumo √© pego da vari√°vel original (j√° que √© readonly)
            const resumoToSheet = pedidoSendoEditado.Resumo_dos_Itens; 

            // Envia no formato que o Apps Script espera
            formData.append('id', pedidoSendoEditado.ID_do_Pedido);
            formData.append('Status', statusToSheet); 
            formData.append('Nome_do_Cliente', nomeToSheet);
            formData.append('Hor√°rio_da_Entrega', horaToSheet);
            formData.append('Total_Final', totalToSheet); 
            formData.append('Resumo_dos_Itens', resumoToSheet); 
            formData.append('Forma_Pagamento', pagamentoToSheet); 
            formData.append('Data_da_Entrega', dataToSheet); 

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const json = await response.json();
                if (json.success) {
                    alert(`Dados do pedido ${pedidoSendoEditado.ID_do_Pedido} atualizados com sucesso!`);
                    closeModal();
                    await fetchPedidos();
                } else {
                    alert(`Falha ao atualizar dados: ${json.message}`);
                }
            } catch (error) {
                alert("Erro de rede ao tentar atualizar os dados.");
            }
        }

        document.getElementById('delete-button').addEventListener('click', () => {
            if (!pedidoSendoEditado) return;
            if (!confirm(`Tem certeza que deseja EXCLUIR o pedido ${pedidoSendoEditado.ID_do_Pedido}? Esta a√ß√£o √© IRREVERS√çVEL (na planilha)!`)) {
                return;
            }
            alert("Aten√ß√£o: A fun√ß√£o de 'delete' (excluir) n√£o est√° implementada na API do Apps Script fornecida. O pedido n√£o foi exclu√≠do.");
            closeModal();
        });


        // =========================================================================
        // INICIALIZA√á√ÉO E EVENTOS
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            const monthFilterInput = document.getElementById('month-filter');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
            
            // Inicializa o filtro de m√™s/ano de entrega para o m√™s atual.
            monthFilterInput.value = `${currentYear}-${currentMonth}`;

            fetchPedidos();

            document.getElementById('refresh-button').addEventListener('click', fetchPedidos);
            // Chama a renderiza√ß√£o/filtro toda vez que o m√™s/ano √© alterado
            monthFilterInput.addEventListener('change', renderKanban); 
            
            setInterval(fetchPedidos, 30000); 
            
            window.addEventListener('click', (event) => {
                // Fecha o modal ao clicar fora
                 if (event.target === modal) {
                     closeModal();
                 }
            });
             
            const calculatorModal = document.getElementById('calculator-modal');
            calculatorModal.addEventListener('click', closeCalculatorModal);
             
        });
    </script>
</body>
</html>
