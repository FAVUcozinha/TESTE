<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEDIDOS FAVU COZINHA AFETIVA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================================= */
        /* CORRE√á√ÉO CR√çTICA DA FONTE */
        /* ========================================================================= */
        @font-face {
            font-family: 'Basic Choice 2';
            /* ‚ö†Ô∏è AJUSTE O CAMINHO DA FONTE SE NECESS√ÅRIO */
            src: url('fonts/Basic Choice 2.ttf') format('truetype'),
                local('Roboto'); 
            font-weight: normal;
            font-style: normal;
        }

        /* ========================================================================= */
        /* ESTILOS BASE, CORES E FORMATA√á√ÉO DE CAMPOS (PADR√ÉO FAVU) */
        /* ========================================================================= */
        body {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            background-color: #7FB1C8; /* Azul */
            margin: 0;
            padding: 0;
            color: #1A2B0F; /* Texto Escuro */
        }
        @media (min-width: 769px) {
            body {
                overflow-y: auto; /* Permite scroll vertical no desktop */
                overflow-x: hidden;
            }
        }
        @media (max-width: 768px) {
            body {
                height: 100vh;
                overflow: hidden; /* Previne scroll da p√°gina inteira no mobile */
            }
        }
        header {
            background-color: #F4E6CB; /* Creme */
            color: #1A2B0F;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-wrap: wrap; 
        }
        h1 { font-size: 24px; margin: 0; }
        h1 .title-line1::after { content: ' FAVU COZINHA AFETIVA'; }
        h1 .title-line2 { display: none; }
        
        /* Controles de Filtro e Bot√µes (Estilo Arredondado) */
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        .controls label, .controls button, .controls input {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            padding: 8px 10px;
            border-radius: 20px; /* Mais arredondado */
            font-size: 14px;
            border: 1px solid #E09F41;
            background-color: #F4E6CB;
            color: #1A2B0F;
            cursor: pointer;
        }
        .controls input[type="month"] { 
            border-radius: 10px; /* Padr√£o 10px para inputs de data/n√∫mero */
            width: 150px; 
            text-align: center; 
            appearance: none; -webkit-appearance: none; -moz-appearance: none; 
        }
        

        #dashboard-totals { text-align: right; line-height: 1.2; padding-right: 15px; order: 1; }
        #dashboard-totals strong { display: block; font-size: 1.5em; color: #E09F41; }
        #dashboard-totals span { font-size: 0.8em; color: #555; }
        
        /* Sistema de Tabs Superior - Estilo de Abas de Documento */
        .main-tabs-container {
            background-color: #F4E6CB;
            padding: 0;
            margin: 0;
            position: relative;
        }
        .main-tabs-header {
            display: flex;
            gap: 0;
            padding: 0;
            margin: 0;
            background-color: #E8D5B5;
            border-bottom: 2px solid #E09F41;
            padding-top: 8px;
            padding-left: 8px;
            padding-right: 8px;
        }
        .main-tab-button {
            flex: 1;
            padding: 12px 20px;
            background-color: #D4C5A5;
            border: none;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            color: #1A2B0F;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            margin-right: 3px;
            box-shadow: inset 0 -2px 5px rgba(0,0,0,0.1);
        }
        .main-tab-button:last-child {
            margin-right: 0;
        }
        .main-tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #D4C5A5;
            z-index: 1;
        }
        .main-tab-button:hover {
            background-color: #C8B99A;
            transform: translateY(-2px);
        }
        .main-tab-button.active {
            background-color: #F4E6CB;
            color: #1A2B0F;
            box-shadow: 0 -3px 8px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.2);
            z-index: 10;
            transform: translateY(-2px);
        }
        .main-tab-button.active::after {
            background-color: #F4E6CB;
            height: 3px;
        }
        .main-tab-content {
            display: none;
            background-color: #F4E6CB;
            padding-top: 0;
        }
        .main-tab-content.active {
            display: block;
        }
        
        /* Estilos para visualiza√ß√£o de Custos */
        .custo-item {
            background-color: #F4E6CB;
            border: 1px solid #E09F41;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .custo-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #7FB1C8;
        }
        .custo-item-nome {
            font-weight: bold;
            font-size: 1.2em;
            color: #1A2B0F;
        }
        .custo-item-data {
            color: #555;
            font-size: 0.9em;
        }
        .custo-item-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .custo-detalhe {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background-color: #E8D5B5;
            border-radius: 5px;
        }
        .custo-detalhe-label {
            font-weight: 600;
            color: #1A2B0F;
        }
        .custo-detalhe-valor {
            color: #E09F41;
            font-weight: bold;
        }
        .custo-total {
            text-align: right;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #E09F41;
        }
        .custo-total-label {
            font-size: 1.3em;
            font-weight: bold;
            color: #1A2B0F;
        }
        .custo-total-valor {
            font-size: 2em;
            font-weight: bold;
            color: #E09F41;
        }
        
        .filter-bar {
            background-color: #F4E6CB; 
            padding: 10px 20px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .search-filter, .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-filter input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #7FB1C8;
            border-radius: 10px;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-size: 14px;
            color: #1A2B0F;
            min-width: 300px;
        }
        .search-filter input[type="text"]:focus {
            outline: none;
            border-color: #E09F41;
        }
        .date-filter {
            position: relative;
        }
        .date-filter input[type="date"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }
        .date-filter input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #7FB1C8;
            border-radius: 10px;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-size: 14px;
            color: #1A2B0F;
            min-width: 120px;
            cursor: pointer;
            background-color: white;
        }
        .date-filter input[type="text"]:focus {
            outline: none;
            border-color: #E09F41;
        }
        
        /* Modal do Calend√°rio */
        #date-picker-modal, #date-picker-modal-custos {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        #date-picker-modal.show, #date-picker-modal-custos.show {
            display: flex;
        }
        .date-picker-content {
            background-color: #F4E6CB;
            border-radius: 10px;
            padding: 20px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .date-picker-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #1A2B0F;
            padding: 5px 10px;
        }
        .date-picker-nav:hover {
            color: #E09F41;
        }
        .date-picker-month-year {
            font-weight: bold;
            font-size: 16px;
            color: #1A2B0F;
        }
        .date-picker-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        .date-picker-weekday {
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            color: #7FB1C8;
            padding: 5px;
        }
        .date-picker-day {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            background-color: white;
            color: #1A2B0F;
            border: 1px solid #ddd;
        }
        .date-picker-day:hover {
            background-color: #E09F41;
            color: white;
        }
        .date-picker-day.selected {
            background-color: #7FB1C8;
            color: white;
            font-weight: bold;
        }
        .date-picker-day.range-start {
            background-color: #7FB1C8;
            color: white;
            font-weight: bold;
            border-radius: 6px 0 0 6px;
        }
        .date-picker-day.range-end {
            background-color: #7FB1C8;
            color: white;
            font-weight: bold;
            border-radius: 0 6px 6px 0;
        }
        .date-picker-day.range-middle {
            background-color: #E3F2FD;
            color: #1A2B0F;
            border-radius: 0;
        }
        .date-picker-day.other-month {
            color: #ccc;
        }
        .date-picker-day.today {
            border: 2px solid #E09F41;
        }
        .date-picker-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        .date-picker-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: bold;
            flex: 1;
        }
        .date-picker-btn.limpar {
            background-color: #EF9A9A;
            color: white;
        }
        .date-picker-btn.hoje {
            background-color: #A5D6A7;
            color: white;
        }
        .date-picker-btn.mes-atual {
            background-color: #7FB1C8;
            color: white;
        }
        .date-picker-btn:hover {
            opacity: 0.8;
        }

        /* ========================================================================= */
        /* ESTILOS KANBAN E RESPONSIVIDADE */
        /* ========================================================================= */
        #kanban-board {
            display: flex;
            align-items: stretch; /* Faz todas as colunas terem a mesma altura */
            gap: 15px;
            padding: 20px;
            padding-bottom: 15px; /* Espa√ßo para a scrollbar */
            overflow-x: auto; 
            overflow-y: visible; /* Permite scroll vertical no desktop */
            -webkit-overflow-scrolling: touch; 
            min-height: calc(100vh - 220px); /* Altura m√≠nima baseada na viewport menos header, tabs e filter-bar */
            scrollbar-width: auto; /* Firefox */
            scrollbar-color: #E09F41 #F4E6CB; /* Firefox */
            position: relative;
            width: 100%;
            max-width: none;
            margin: 0;
            background-color: #7FB1C8; /* Fundo azul atr√°s das colunas */
            border-radius: 10px;
            flex-wrap: nowrap;
            justify-content: flex-start;
        }
        @media (max-width: 768px) {
            #kanban-board {
                overflow-y: hidden;
                height: calc(100vh - 250px); /* Altura fixa no mobile considerando tabs */
            }
        }
        
        /* Estiliza√ß√£o da scrollbar para Chrome, Edge, Safari */
        #kanban-board::-webkit-scrollbar {
            height: 16px; /* Scrollbar mais alta para melhor visibilidade */
        }
        
        #kanban-board::-webkit-scrollbar-track {
            background: #F4E6CB;
            border-radius: 10px;
            position: sticky;
            bottom: 0;
        }
        
        #kanban-board::-webkit-scrollbar-thumb {
            background: #E09F41;
            border-radius: 10px;
            border: 2px solid #F4E6CB;
        }
        
        #kanban-board::-webkit-scrollbar-thumb:hover {
            background: #c2883a;
        }
        .kanban-column {
            flex-basis: 280px; 
            flex-shrink: 0;
            min-width: 260px; /* Largura m√≠nima para evitar corte de texto */
            max-width: 100%; /* Respeita a largura do container */
            background-color: #F4E6CB;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            min-height: 70vh;
            display: flex;
            flex-direction: column; /* Organiza o conte√∫do verticalmente */
        }
        .column-header {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            padding: 8px 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid #E09F41; 
            text-align: center;
            color: #1A2B0F;
            white-space: nowrap; /* Evita quebra de linha */
            overflow: hidden;
            text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
            word-wrap: break-word; /* Permite quebra de palavras longas se necess√°rio */
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .column-header-text {
            flex: 1;
            text-align: center;
        }
        .column-select-all-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .column-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
            max-height: 5000px; /* Valor alto para permitir anima√ß√£o suave */
            flex-grow: 1; /* Faz o conte√∫do expandir para preencher o espa√ßo dispon√≠vel */
        }
        .kanban-column.collapsed .column-content {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            padding: 0;
        }
        
        /* Estilos Mobile */
        @media (max-width: 768px) {
            header { flex-direction: column; align-items: flex-start; padding-bottom: 10px; }
            h1 { width: 100%; text-align: center; margin-bottom: 10px; display: flex; flex-direction: column; line-height: 1.3; }
            h1 .title-line1::after { content: ''; }
            h1 .title-line2 { display: block; margin-top: 2px; }
            .controls { justify-content: space-around; width: 100%; margin-bottom: 10px; }
            .main-tab-button {
                font-size: 14px;
                padding: 10px 8px;
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
            }
            .main-tabs-header {
                padding-top: 6px;
                padding-left: 4px;
                padding-right: 4px;
            }
            .filter-bar { flex-direction: column; align-items: flex-start; padding: 10px; }
            .filter-bar > * { width: 100%; margin-top: 5px; }
            .search-filter { width: 100%; }
            .search-filter input[type="text"] { 
                width: 100%; 
                min-width: 0; 
                max-width: 100%; 
                box-sizing: border-box; 
            }
            .date-filter { width: 100%; }
            .date-filter input[type="date"] { 
                width: 100%; 
                max-width: 100%; 
                box-sizing: border-box; 
            }
            #dashboard-totals { text-align: center; width: 100%; padding-right: 0; margin-bottom: 10px; }
            #kanban-board { 
                flex-direction: column; 
                padding: 10px; 
                gap: 10px; 
                overflow-x: hidden; 
                overflow-y: auto;
                height: calc(100vh - 250px);
            }
            .kanban-column { 
                width: 100%; 
                flex-basis: auto;
                min-width: 100%; /* Garante largura total no mobile */
                max-width: 100%;
                min-height: auto;
                margin-bottom: 10px;
            }
            .kanban-column.collapsed {
                min-height: 60px;
            }
            .column-header {
                padding: 15px 10px;
                margin-bottom: 0;
                cursor: default;
                user-select: none;
                white-space: normal; /* Permite quebra de linha no mobile */
                word-wrap: break-word;
                overflow: visible;
                text-overflow: clip;
            }
            .column-header-text {
                cursor: pointer;
            }
            .column-select-all-checkbox {
                width: 18px;
                height: 18px;
            }
            .column-content {
                max-height: 1000px;
            }
            .card-status-etapa {
                display: block; /* Mostra o select de status no mobile */
            }
            .pedido-card {
                pointer-events: auto;
            }
        }
        
        /* Responsividade adicional baseada em largura */
        @media (max-width: 480px) {
            .main-tab-button {
                font-size: 12px;
                padding: 10px 8px;
            }
            #kanban-board {
                height: calc(100vh - 270px);
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-tab-button {
                font-size: 15px;
                padding: 14px 18px;
            }
        }

        /* Cores de Status */
        .pedido-card { background-color: white; border: 1px solid #ddd; border-left: 5px solid #7FB1C8; border-radius: 6px; padding: 10px; margin-bottom: 10px; cursor: pointer; color: #1A2B0F; position: relative; }
        .pedido-card.com-observacao { border-left: 5px solid #FF9800 !important; }
        .card-observacao-alerta {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #FF9800;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 8px;
        }
        .card-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 100;
        }
        .pedido-card.selected {
            border: 2px solid #E09F41;
            box-shadow: 0 0 10px rgba(224, 159, 65, 0.5);
        }
        /* Barra de A√ß√µes em Lote */
        #bulk-actions-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #F4E6CB;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            z-index: 1500;
            gap: 10px;
            align-items: center;
        }
        #bulk-actions-bar.show {
            display: flex;
        }
        #bulk-actions-bar span {
            margin-right: 15px;
            font-weight: bold;
            color: #1A2B0F;
        }
        #bulk-actions-bar button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-weight: bold;
            color: white;
            margin: 0 5px;
        }
        #bulk-move-btn { background-color: #7FB1C8; }
        #bulk-payment-btn { background-color: #E09F41; }
        #bulk-send-btn { background-color: #2ecc71; }
        #bulk-actions-bar button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        /* Modais de A√ß√µes em Lote */
        #bulk-move-modal, #bulk-payment-modal, #bulk-send-modal {
            z-index: 2000;
        }
        #bulk-move-modal .modal-content, #bulk-payment-modal .modal-content, #bulk-send-modal .modal-content {
            max-width: 500px;
        }
        #bulk-send-modal button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-weight: bold;
            color: white;
        }
        .card-id { font-size: 0.85em; position: absolute; top: 10px; right: 10px; color: #7FB1C8; font-weight: bold; }
        .card-obs-badge {
            display: inline-block;
            background-color: #FF9800;
            color: white;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
            vertical-align: middle;
        }
        .card-title { font-weight: bold; font-size: 1.1em; margin-top: 25px; margin-bottom: 12px; }
        .card-detail { font-size: 0.9em; margin-bottom: 6px; }
        .card-status-pagamento { margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        .card-status-pagamento label { display: inline-block; font-size: 0.85em; font-weight: bold; color: #1A2B0F; margin: 0; white-space: nowrap; }
        .card-status-pagamento select { flex: 1; padding: 6px; border: 1px solid #7FB1C8; border-radius: 6px; background-color: white; color: #1A2B0F; font-family: 'Basic Choice 2', 'Roboto', sans-serif; font-size: 0.9em; cursor: pointer; text-align: center; }
        .card-status-pagamento select:focus { outline: none; border-color: #E09F41; }
        .card-status-etapa { margin-top: 8px; display: none; } /* Oculto por padr√£o, vis√≠vel apenas no mobile */
        .card-status-etapa label { display: block; font-size: 0.85em; font-weight: bold; color: #1A2B0F; margin-bottom: 5px; }
        .card-status-etapa select { width: 100%; padding: 8px; border: 1px solid #7FB1C8; border-radius: 6px; background-color: white; color: #1A2B0F; font-family: 'Basic Choice 2', 'Roboto', sans-serif; font-size: 0.9em; cursor: pointer; }
        .card-status-etapa select:focus { outline: none; border-color: #E09F41; }
        .status-Pedido-Recebido { border-left-color: #17a2b8; } 
        .status-Pedido-Confirmado { border-left-color: #E09F41; } 
        .status-Aguardando-Retirada { border-left-color: #1abc9c; } 
        .status-Entregue { border-left-color: #2ecc71; } 
        .status-Cancelado { border-left-color: #E60000; opacity: 0.6; } 
        
        /* Compacta√ß√£o e layout horizontal no desktop */
        @media (min-width: 769px) {
            #kanban-board {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            .kanban-column {
                flex-basis: 280px;
                min-width: 260px;
            }
            .pedido-card {
                padding: 8px;
                margin-bottom: 8px;
            }
            .card-id {
                top: 6px;
                right: 8px;
            }
            .card-title {
                font-size: 1em;
                margin-top: 12px;
                margin-bottom: 8px;
            }
            .card-detail {
                font-size: 0.85em;
                margin-bottom: 4px;
            }
            .card-status-pagamento {
                margin-top: 6px;
                gap: 6px;
            }
            .card-status-pagamento select {
                padding: 5px 6px;
                font-size: 0.85em;
            }
            .card-status-etapa select {
                padding: 6px;
                font-size: 0.85em;
            }
        }
        
        /* Cores de fundo por status de pagamento - apenas na √°rea do status */
        .card-status-pagamento.pagamento-pendente { 
            background-color: #FF9FA8; 
            padding: 8px;
            border-radius: 6px;
        }
        .card-status-pagamento.pagamento-50 { 
            background-color: #FFF59D; 
            padding: 8px;
            border-radius: 6px;
        }
        .card-status-pagamento.pagamento-pago { 
            background-color: #A5D6A7; 
            padding: 8px;
            border-radius: 6px;
        } 
        
        /* Estilos do Modal */
        .modal { 
            /* üö® CORRE√á√ÉO CR√çTICA: display: none como padr√£o */
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            /* Propriedades de centraliza√ß√£o aplicadas quando o JS define display: flex */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content { 
            background-color: #F4E6CB; 
            border-radius: 10px; 
            padding: 25px; 
            max-width: 650px; 
            width: 90%;
            position: relative; 
            margin: auto; /* Garante compatibilidade de centraliza√ß√£o */
        }
        .close-button { color: #E09F41; float: right; font-size: 30px; font-weight: bold; position: absolute; top: 10px; right: 20px; }
        #modal-title { color: #000000; display: none; }
        #pedido-id { 
            position: absolute; 
            top: 10px; 
            right: 50px; 
            color: #7FB1C8; 
            font-weight: bold; 
            font-size: 1.4em; 
        }
        #modal-details { 
            color: #000000; 
            margin-top: 50px; /* Espa√ßo para o ID do pedido n√£o sobrepor */
        }
        #modal-details strong { color: #000000; }
        #modal-details p { color: #000000; margin: 0; }
        #modal-details p span { color: #000000; }
        #modal-details .detail-group { margin-bottom: 16px; }
        #modal-details .detail-group:last-of-type { margin-bottom: 0; }
        #modal-details pre { white-space: pre-wrap; background-color: white; padding: 10px; border-radius: 4px; border: 1px solid #7FB1C8; color: #000000; margin-top: 8px; }
        
        /* Sistema de Abas */
        .tabs-container {
            margin-top: 10px;
        }
        .tabs-header {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #7FB1C8;
            margin-bottom: 15px;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            color: #1A2B0F;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-button:hover {
            background-color: rgba(127, 181, 200, 0.1);
        }
        .tab-button.active {
            color: #7FB1C8;
            border-bottom-color: #E09F41;
        }
        .tab-pane {
            display: none;
            padding: 10px 0;
        }
        .tab-pane.active {
            display: block;
        }
        
        /* Inputs e Bot√µes de Edi√ß√£o (Estilo Favou) */
        #edit-form input, #edit-form textarea, #edit-form select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #7FB1C8; 
            border-radius: 10px; 
            background-color: white;
            color: #1A2B0F;
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
        }
        #edit-form textarea[readonly] {
             background-color: #eee; /* Cor de fundo para campo n√£o edit√°vel */
             cursor: not-allowed;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 15px;
            width: 100%;
            padding-right: 0;
        }
        .modal-actions button, #edit-form button {
            font-family: 'Basic Choice 2', 'Roboto', sans-serif;
            padding: 12px 20px;
            margin-top: 0;
            border: none;
            border-radius: 20px; 
            cursor: pointer;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px #4c7e93; 
        }
        #edit-form button:active { box-shadow: 0 2px #4c7e93; transform: translateY(2px); }

        /* Cores dos Bot√µes de A√ß√£o */
        #edit-button { background-color: #2ecc71; box-shadow: 0 4px #1c8d50; } 
        #edit-form button[type="submit"] { background-color: #2ecc71; box-shadow: 0 4px #1c8d50; } 
        #cancel-edit { background-color: #e74c3c; box-shadow: 0 4px #c0392b; } 
        #open-calculator-button { background-color: #7FB1C8; box-shadow: 0 4px #4c7e93; margin-right: 10px; margin-bottom: 10px; border-radius: 20px; }
        
        #resumo-editor-section { padding: 10px; background-color: #F4E6CB; border-radius: 8px; margin-top: 10px; border: 1px solid #7FB1C8; }
        #calculator-modal { 
            background-color: rgba(0,0,0,0.8); 
            z-index: 1100; 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            justify-content: center; 
            align-items: center; 
        }
        #calculator-iframe { width: 95%; height: 95%; border: 5px solid #E09F41; border-radius: 15px; background-color: white; }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2ecc71;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
        }
        
        #toast.show {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

    </style>
</head>
<body>

    <header>
        <h1><span class="title-line1">Pedidos</span><span class="title-line2">Favu cozinha afetiva</span></h1>
        <div class="controls">
             <div id="dashboard-totals">
                 <strong>R$ 0,00</strong>
                 <span id="total-pedidos">0 pedidos</span>
             </div>
        </div>
    </header>

    <div id="main-tab-pedidos" class="main-tab-content active">
    <div class="filter-bar">
            <div class="search-filter">
                <label for="search-filter">Buscar:</label>
                <input type="text" id="search-filter" placeholder="ID do pedido, nome ou n√∫mero do cliente" value="">
            </div>
            <div class="date-filter">
                <label for="date-filter">Data de Entrega:</label>
                <input type="date" id="date-filter" value="">
                <input type="hidden" id="date-filter-inicial" value="">
                <input type="text" id="date-filter-display" readonly placeholder="MM/AAAA">
            </div>
        </div>

        <div id="date-picker-modal">
            <div class="date-picker-content">
                <div class="date-picker-header">
                    <button class="date-picker-nav" id="prev-month">‚Äπ</button>
                    <div class="date-picker-month-year" id="month-year-display"></div>
                    <button class="date-picker-nav" id="next-month">‚Ä∫</button>
                </div>
                <div class="date-picker-calendar" id="calendar-grid"></div>
                <div class="date-picker-buttons">
                    <button class="date-picker-btn limpar" id="btn-limpar">Limpar</button>
                    <button class="date-picker-btn hoje" id="btn-hoje">Hoje</button>
                    <button class="date-picker-btn mes-atual" id="btn-mes-atual">M√™s Atual</button>
                </div>
            </div>
    </div>

    <main id="kanban-board">
    </main>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <span id="pedido-id"></span>
            <br><br>
            <div id="modal-details">
                <div class="detail-group">
                    <p><strong>Nome do Cliente:</strong> <span id="detail-nome"></span></p>
                    <p><strong>N√∫mero:</strong> <span id="detail-numero"></span></p>
                </div>
                
                <div class="detail-group">
                    <p><strong>Data de Entrega:</strong> <span id="detail-data"></span></p>
                    <p><strong>Hor√°rio de Entrega:</strong> <span id="detail-horario"></span></p>
                </div>
                
                <div class="detail-group">
                <p><strong>Forma de Pagamento:</strong> <span id="detail-pagamento"></span></p>
                    <p><strong>Status do Pagamento:</strong> <span id="detail-status-pagamento"></span></p>
                </div>
                
                <div class="detail-group">
                    <p><strong>Cupom:</strong> <span id="detail-cupom"></span></p>
                <p><strong>Total Final:</strong> <span id="detail-total-final"></span></p>
                </div>
                
                <div class="detail-group" id="detail-observacoes-group" style="display: none;">
                    <div style="background-color: #FFF3CD; border: 2px solid #FF9800; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <p style="margin: 0; font-weight: bold; color: #856404; font-size: 1.1em; margin-bottom: 8px;">‚ö†Ô∏è Observa√ß√µes:</p>
                        <p style="margin: 0; color: #856404; white-space: pre-wrap;" id="detail-observacoes"></p>
                    </div>
                </div>
                
                <div class="detail-group">
                    <strong>Resumo do pedido:</strong> 
                <pre id="detail-resumo-itens"></pre>
                </div>
            </div>

            <div class="modal-actions">
                <button id="edit-button">Editar Pedido</button>
            </div>

            <form id="edit-form" style="display: none;">
                <h3>Editar Dados do Pedido</h3>
                
                <label>Nome do Cliente:</label>
                <input type="text" id="edit-nome" required><br>
                
                <label>N√∫mero:</label>
                <input type="text" id="edit-numero" required><br>
                
                <label>Data de Entrega (DD/MM/AAAA):</label>
                <input type="text" id="edit-data" required placeholder="DD/MM/AAAA"><br> 
                
                <label>Hor√°rio de Entrega (HH:MM):</label>
                <input type="time" id="edit-horario" required><br>
                
                <label for="edit-pagamento">Forma de Pagamento:</label>
                <select id="edit-pagamento" name="pagamento" required>
                    <option value="Pix">Pix</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Cart√£o">Cart√£o</option>
                </select><br>

                <label for="edit-status-pagamento">Status do Pagamento:</label>
                <select id="edit-status-pagamento" name="status-pagamento" required>
                    <option value="Pendente">Pendente</option>
                    <option value="Pago 50%">Pago 50%</option>
                    <option value="Pago 100%">Pago 100%</option>
                </select><br>

                <label>Cupom:</label>
                <input type="text" id="edit-cupom"><br>

                <label>Total Final (R$):</label>
                <input type="number" step="0.01" id="edit-total" required><br>

                <label>Resumo dos Itens (N√ÉO EDIT√ÅVEL):</label>
                <div id="resumo-editor-section">
                    <textarea id="edit-resumo" rows="8" readonly required></textarea> 
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" id="cancel-edit" style="flex-grow: 1;">Cancelar Edi√ß√£o</button>
                    <button type="submit" style="flex-grow: 1;">Salvar Edi√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="calculator-modal" class="modal" onclick="closeCalculatorModal(event)">
        <div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
             <iframe id="calculator-iframe" src="" frameborder="0"></iframe>
        </div>
    </div>


    <script>
        // =========================================================================
        // JAVASCRIPT (L√ìGICA)
        // =========================================================================

        const API_URL = 'https://script.google.com/macros/s/AKfycbyDgaN7zfkao8FjLaa-WyHX3IXcQGDLNV3LGgNsra3LJLjVQOhnq2ezF_CszFYYN8GLfQ/exec'; 
        const CALCULATOR_URL = 'https://favucozinha.github.io/Calculadora-Favu/'; 

        // ARRAY FINAL DE STATUS
        const KANBAN_STATUSES = [
            'Pedido Recebido',
            'Pedido Confirmado',
            'Aguardando Retirada',
            'Entregue', 
            'Cancelado'
        ];

        // Fun√ß√£o helper para normalizar status (case-insensitive)
        // Converte para o formato padr√£o: primeira letra mai√∫scula, resto min√∫scula
        function normalizeStatus(status) {
            if (!status) return '';
            // Converte para min√∫sculas e depois capitaliza cada palavra
            return status.toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Fun√ß√£o helper para comparar status (case-insensitive)
        function statusEquals(status1, status2) {
            return normalizeStatus(status1) === normalizeStatus(status2);
        }

        let todosOsPedidos = [];
        let todosOsCustos = [];
        let pedidoSendoEditado = null;
        let isUpdating = false; // Trava de atualiza√ß√£o para evitar conflitos durante opera√ß√µes
        let requestQueue = []; // Fila de requisi√ß√µes para processar sequencialmente
        let isProcessingQueue = false; // Indica se a fila est√° sendo processada
        
        // =========================================================================
        // FUN√á√ïES DE UTILIDADE E CORRE√á√ÉO DE DATA/HORA
        // =========================================================================

        /**
         * Retorna a data no formato DD/MM/YYYY.
         */
        function formatDate(dateString) {
            if (dateString && typeof dateString === 'string') {
                const match = dateString.match(/(\d{2}\/\d{2}\/\d{4})/);
                if (match) return match[0];
            }
            return 'N/A';
        }
        
        /**
         * Retorna a hora no formato HH:MM.
         */
        function formatTime(timeValue) {
             if (!timeValue) return 'N/A';
             const timeString = String(timeValue);
             const match = timeString.match(/(\d{1,2}:\d{2})/);
             if (match) {
                 let [h, m] = match[0].split(':');
                 return `${h.padStart(2, '0')}:${m}`;
             }
             return 'N/A';
        }
        
        /**
         * Limpa o hor√°rio para garantir formato HH:mm como string pura.
         * Backend j√° envia hora como texto (ex.: "16:00") ‚Äî n√£o aplicar -8h.
         */
        function limparHorario(horarioRaw) {
            if (horarioRaw === null || horarioRaw === undefined || horarioRaw === '') return '00:00';
            
            // Valores num√©ricos (fra√ß√£o de dia do Sheets)
            if (typeof horarioRaw === 'number' && !isNaN(horarioRaw)) {
                const totalMinutos = Math.round((horarioRaw % 1) * 24 * 60);
                const hNum = Math.floor(totalMinutos / 60) % 24;
                const mNum = totalMinutos % 60;
                return `${String(hNum).padStart(2, '0')}:${String(mNum).padStart(2, '0')}`;
            }
            
            // Date object: usa hora local sem ajustes manuais
            if (horarioRaw instanceof Date) {
                const horas = String(horarioRaw.getHours()).padStart(2, '0');
                const minutos = String(horarioRaw.getMinutes()).padStart(2, '0');
                return `${horas}:${minutos}`;
            }
            
            const horarioStr = String(horarioRaw).trim();
            
            // Formato ISO: converte para hora local
            if (horarioStr.includes('T')) {
                const d = new Date(horarioStr);
                if (!isNaN(d.getTime())) {
                    const horas = String(d.getHours()).padStart(2, '0');
                    const minutos = String(d.getMinutes()).padStart(2, '0');
                    return `${horas}:${minutos}`;
                }
            }
            
            // Extrai primeiro HH:mm encontrado em texto
            const match = horarioStr.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                const h = match[1].padStart(2, '0');
                const m = match[2];
                return `${h}:${m}`;
            }
            
            return '00:00';
        }

        /**
         * Converte data ISO (2025-12-25T08:00:00.000Z) para DD/MM/YYYY (25/12/2025)
         */
        function formatISOtoDDMMYYYY(dateValue) {
            if (!dateValue) return '';
            
            try {
                // Se for string ISO, converte para Date
                let dateObj;
                if (typeof dateValue === 'string' && dateValue.includes('T')) {
                    dateObj = new Date(dateValue);
                } else if (dateValue instanceof Date) {
                    dateObj = dateValue;
                } else {
                    return String(dateValue);
                }
                
                // Verifica se a data √© v√°lida
                if (isNaN(dateObj.getTime())) {
                    return String(dateValue);
                }
                
                // Formata para DD/MM/YYYY
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                
                return `${day}/${month}/${year}`;
            } catch (e) {
                console.warn('Erro ao converter data ISO:', dateValue, e);
                return String(dateValue);
            }
        }

        /**
         * Converte string DD/MM/AAAA para YYYY-MM-DD (para fins de filtro e Date Object).
         * Melhorada para lidar com diferentes formatos e tipos de dados.
         */
        function formatDDMMYYYYtoYYYYMMDD(dateString) {
            if (!dateString) return null;
            
            // Converte para string e remove espa√ßos
            let dateStr = String(dateString).trim();
            
            // Se for um objeto Date, converte para string DD/MM/YYYY
            if (dateString instanceof Date) {
                const day = String(dateString.getDate()).padStart(2, '0');
                const month = String(dateString.getMonth() + 1).padStart(2, '0');
                const year = dateString.getFullYear();
                dateStr = `${day}/${month}/${year}`;
            }
            
            // Tenta diferentes separadores
            let parts = [];
            if (dateStr.includes('/')) {
                parts = dateStr.split('/');
            } else if (dateStr.includes('-')) {
                parts = dateStr.split('-');
                // Se estiver no formato YYYY-MM-DD, inverte para DD/MM/YYYY
                if (parts[0].length === 4) {
                    parts = [parts[2], parts[1], parts[0]];
                }
            } else {
                console.warn('Formato de data inv√°lido:', dateString);
                return null;
            }
            
            if (parts.length === 3) {
                // Normaliza os valores (remove zeros √† esquerda para compara√ß√£o, mas mant√©m para formato)
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                
                // Valida se s√£o n√∫meros v√°lidos
                if (isNaN(day) || isNaN(month) || isNaN(year)) {
                    console.warn('Data cont√©m valores n√£o num√©ricos:', dateString);
                    return null;
                }
                
                return `${year}-${month}-${day}`;
            }
            
            console.warn('Formato de data inv√°lido (n√£o conseguiu dividir em 3 partes):', dateString);
            return null;
        }

        /**
         * Extrai apenas a lista de itens do resumo de texto longo (Coluna J).
         */
        function extractResumoItens(fullResumo) {
            if (!fullResumo) return 'N/A';
            
            const startKey = '- Resumo do pedido:';
            const endKey = 'Total Final:';
            
            const startIndex = fullResumo.indexOf(startKey);
            const endIndex = fullResumo.indexOf(endKey);

            if (startIndex !== -1) {
                let resumo = fullResumo.substring(startIndex + startKey.length).trim();
                
                if (endIndex !== -1 && endIndex > startIndex) {
                    resumo = fullResumo.substring(startIndex + startKey.length, endIndex).trim();
                }
                
                return resumo.replace(/^\s*\n/g, '').replace(/\n\s*$/g, '');
            }

            return fullResumo;
        }

        /**
         * Processa os itens de um pedido e organiza por categoria
         */
        function processarItensPorCategoria(resumo) {
            const itensPorCategoria = {
                'Bolos Tradicionais': [],
                'Bolos Especiais': [],
                'Doces': [],
                'Cookies': [],
                'Salgados Fritos': [],
                'Salgados Assados': [],
                'Salgados Vegetarianos': [],
                'Pratos Salgados': []
            };
            
            if (!resumo || resumo === 'N/A') return itensPorCategoria;
            
            const linhas = resumo.split('\n');
            let categoriaAtual = '';
            
            linhas.forEach(linha => {
                linha = linha.trim();
                if (!linha) return;
                
                // Detecta categoria
                if (linha.toLowerCase().includes('bolos tradicionais')) {
                    categoriaAtual = 'Bolos Tradicionais';
                    return;
                } else if (linha.toLowerCase().includes('bolos especiais')) {
                    categoriaAtual = 'Bolos Especiais';
                    return;
                } else if (linha.toLowerCase().includes('doces') && !linha.toLowerCase().includes('doce')) {
                    categoriaAtual = 'Doces';
                    return;
                } else if (linha.toLowerCase().includes('cookies')) {
                    categoriaAtual = 'Cookies';
                    return;
                } else if (linha.toLowerCase().includes('salgados fritos')) {
                    categoriaAtual = 'Salgados Fritos';
                    return;
                } else if (linha.toLowerCase().includes('salgados assados')) {
                    categoriaAtual = 'Salgados Assados';
                    return;
                } else if (linha.toLowerCase().includes('salgados vegetarianos')) {
                    categoriaAtual = 'Salgados Vegetarianos';
                    return;
                } else if (linha.toLowerCase().includes('pratos salgados')) {
                    categoriaAtual = 'Pratos Salgados';
                    return;
                }
                
                // Se n√£o tem categoria ou n√£o √© uma linha de item, pula
                if (!categoriaAtual || !linha.includes('=')) return;
                
                let nomeItem = '';
                let tamanhoPeso = '';
                let qtd = 0;
                let itemFormatado = '';
                
                // Padr√£o 1: Bolos com tamanho "Nome - Tamanho (Peso KG) - Qtd unidades"
                let match = linha.match(/(.+?)\s*-\s*([PMG])\s*\(([\d.]+)\s*KG\)\s*-\s*(\d+)\s*unidades/i);
                if (match) {
                    nomeItem = match[1].trim();
                    const tamanho = match[2];
                    const peso = match[3];
                    qtd = parseInt(match[4]);
                    tamanhoPeso = `${tamanho} (${peso} KG)`;
                    itemFormatado = `${qtd} un. - ${nomeItem} - ${tamanhoPeso}`;
                } else {
                    // Padr√£o 2: Cheesecake "Nome - Peso KG - Qtd unidades"
                    match = linha.match(/(.+?)\s*-\s*([\d.]+)\s*KG\s*-\s*(\d+)\s*unidades/i);
                    if (match) {
                        nomeItem = match[1].trim();
                        const peso = match[2];
                        qtd = parseInt(match[3]);
                        tamanhoPeso = `${peso} KG`;
                        itemFormatado = `${qtd} un. - ${nomeItem} (${tamanhoPeso})`;
                    } else {
                        // Padr√£o 3: Doces/Salgados "Nome - Qtd unidades"
                        match = linha.match(/(\*?)(.+?)\s*-\s*(\d+)\s*unidades/i);
                        if (match) {
                            const asterisco = match[1];
                            nomeItem = (asterisco + match[2]).trim();
                            qtd = parseInt(match[3]);
                            itemFormatado = `${qtd} un. - ${nomeItem}`;
                        } else {
                            // Padr√£o 4: Fallback gen√©rico "Nome - Qtd un."
                            match = linha.match(/(.+?)\s*-\s*(\d+)\s*un\./i);
                            if (match) {
                                nomeItem = match[1].trim();
                                qtd = parseInt(match[2]);
                                itemFormatado = `${qtd} un. - ${nomeItem}`;
                            }
                        }
                    }
                }
                
                if (itemFormatado && qtd > 0 && categoriaAtual) {
                    itensPorCategoria[categoriaAtual].push(itemFormatado);
                }
            });
            
            return itensPorCategoria;
        }
        
        // =========================================================================
        // FUN√á√ïES DE COMUNICA√á√ÉO E RENDERIZA√á√ÉO
        // =========================================================================

        async function fetchPedidos() {
            // N√£o atualiza se estiver em opera√ß√£o (drag & drop, edi√ß√£o, etc) ou processando fila
            if (isUpdating || isProcessingQueue) {
                return;
            }
            
            document.getElementById('total-pedidos').textContent = '...';

            try {
                // Adiciona timestamp para evitar cache
                const response = await fetch(`${API_URL}?action=read&t=${Date.now()}`);
                const json = await response.json();
                
                // Log de depura√ß√£o
                console.log('Dados recebidos da planilha:', json);
                
                // Log do primeiro pedido bruto para ver os nomes das colunas
                if (json.pedidos && json.pedidos.length > 0) {
                    console.log('Primeiro pedido bruto:', json.pedidos[0]);
                    console.log('Campo Numero no primeiro pedido:', json.pedidos[0].Numero, json.pedidos[0]["Numero"], json.pedidos[0].numero);
                }

                if (json.success) {
                    // Verifica se h√° pedidos
                    if (!json.pedidos || json.pedidos.length === 0) {
                        const kanbanBoard = document.getElementById('kanban-board');
                        kanbanBoard.innerHTML = '<div style="text-align: center; padding: 40px; color: #1A2B0F; font-size: 18px; background-color: #F4E6CB; border-radius: 8px; margin: 20px;">Nenhum pedido encontrado na aba Pedidos</div>';
                        document.getElementById('total-pedidos').textContent = '0 pedidos';
                        return;
                    }
                    
                    todosOsPedidos = json.pedidos.map(p => {
                        // Mapeamento flex√≠vel para evitar N/A
                        // Data pode vir como ISO (2025-12-25T08:00:00.000Z) ou DD/MM/YYYY
                        let dataEntregaRaw = p.Data_Entrega || p["Data da Entrega"] || p.Data || "";
                        
                        // Converte data ISO para DD/MM/YYYY se necess√°rio - sempre como String
                        let dataEntrega = '';
                        if (dataEntregaRaw) {
                            if (String(dataEntregaRaw).includes('T') || dataEntregaRaw instanceof Date) {
                                // √â formato ISO ou Date object
                                dataEntrega = formatISOtoDDMMYYYY(dataEntregaRaw);
                            } else {
                                // J√° est√° em formato DD/MM/YYYY - garante que seja String
                                dataEntrega = String(dataEntregaRaw).trim();
                            }
                        }
                        // Garante que dataEntrega seja sempre String (evita N/A ou formatos estranhos)
                        if (!dataEntrega || dataEntrega === 'Invalid Date' || dataEntrega === 'NaN/NaN/NaN') {
                            dataEntrega = '';
                        }
                        
                        // Tratamento estrito do hor√°rio como String - ignora fuso hor√°rio
                        const horarioEntregaRaw = p.Horario_Entrega || p["Horario da Entrega"] || p.Horario || "";
                        // Limpa o hor√°rio para garantir formato HH:mm como string pura
                        const horarioEntrega = limparHorario(horarioEntregaRaw);
                        
                        // Numero deve ser da coluna C (Numero) - mapeamento simplificado
                        const numero = p.Numero || p['Numero'] || p.numero || '';
                        const nome = p.Nome_Cliente || p["Nome do Cliente"] || p.Nome || "";
                        const id = p.ID_do_Pedido || p.ID || "";
                        // Normaliza o status para garantir consist√™ncia (case-insensitive)
                        const statusRaw = p.Status_do_Pedido || p.Status || "Pedido Recebido";
                        const status = normalizeStatus(statusRaw);
                        const total = p.Total_Final || p["Total Final"] || 0;

                        // Converte DD/MM/AAAA para YYYY-MM-DD para o filtro e input HTML
                        const dataParaInput = formatDDMMYYYYtoYYYYMMDD(dataEntrega);
                        
                        // Log de aviso se a data n√£o p√¥de ser processada
                        if (dataEntrega && dataEntrega !== 'N/A' && !dataParaInput) {
                            console.warn(`Pedido ${id || 'sem ID'}: Data em formato inv√°lido que n√£o p√¥de ser processada:`, dataEntrega);
                        }
                        
                        let sortDate = new Date(0); 
                        
                        // Cria um Date Object para ordena√ß√£o (data + hor√°rio)
                        // Usa o hor√°rio j√° limpo (string HH:mm)
                        if (dataParaInput) {
                           try {
                                const horaParaOrdenacao = horarioEntrega || '00:00';
                                sortDate = new Date(`${dataParaInput.replace(/-/g, '/')} ${horaParaOrdenacao}`);
                                
                                // Verifica se a data √© v√°lida
                                if (isNaN(sortDate.getTime())) {
                                    sortDate = new Date(0);
                                }
                           } catch(e) {
                                console.warn(`Pedido ${id || 'sem ID'}: Erro ao criar Date Object para ordena√ß√£o:`, e.message);
                                sortDate = new Date(0);
                           }
                        }
                        
                        return {
                            ...p,
                            ID_do_Pedido: String(id || ''),
                            Nome_Cliente: String(nome || ''),
                            Numero: String(numero), // Coluna C (Numero) - sempre String
                            Data_Entrega: String(dataEntrega || ''), // Formato DD/MM/YYYY - sempre String
                            Horario_Entrega: horarioEntrega, // J√° limpo como string HH:mm
                            Status_do_Pedido: status,
                            Status: status, // Mant√©m Status para compatibilidade
                            Status_Pagamento: p.Status_Pagamento || p["Status do Pagamento"] || 'Pendente',
                            Total_Final: total,
                            Data_para_Input: dataParaInput, // YYYY-MM-DD (para filtro)
                            sortDate: sortDate,
                            Observacoes: String(p.Observacoes || p["Observa√ß√µes"] || p.Observacoes || '') // Coluna L
                        };
                    }).filter(p => p.ID_do_Pedido); 
                    
                    todosOsPedidos.sort((a, b) => a.sortDate - b.sortDate);

                    renderKanban();
                    // updateDashboardTotals √© chamado dentro de renderKanban
                } else {
                    console.error("Erro ao buscar pedidos:", json.message);
                    alert("Erro ao carregar os pedidos: " + json.message);
                }
            } catch (error) {
                console.error("Erro na comunica√ß√£o com a API (Network/Parsing):", error);
                alert("Erro de rede ao carregar os pedidos. Verifique o console para detalhes.");
            }
        }

        // =========================================================================
        // FUN√á√ïES PARA CUSTOS
        // =========================================================================

        async function fetchCustos() {
            try {
                const response = await fetch(`${API_URL}?action=readCustos`);
                const json = await response.json();
                
                if (json.success) {
                    if (!json.custos || json.custos.length === 0) {
                        todosOsCustos = [];
                        renderCustos();
                        return;
                    }
                    
                    todosOsCustos = json.custos.map(c => {
                        let dataRaw = c.Data || c["Data"] || "";
                        let data = '';
                        
                        if (dataRaw) {
                            if (String(dataRaw).includes('T') || dataRaw instanceof Date) {
                                data = formatISOtoDDMMYYYY(dataRaw);
                            } else {
                                data = String(dataRaw).trim();
                            }
                        }
                        
                        if (!data || data === 'Invalid Date' || data === 'NaN/NaN/NaN') {
                            data = '';
                        }
                        
                        const dataParaInput = formatDDMMYYYYtoYYYYMMDD(data);
                        
                        return {
                            ...c,
                            Nome_Item: String(c.Nome_Item || c["Nome do Item"] || c.Item || ''),
                            Data: String(data || ''),
                            Data_para_Input: dataParaInput,
                            Quantidade: parseFloat(c.Quantidade || c["Quantidade"] || 0),
                            Valor_Unitario: parseFloat(c.Valor_Unitario || c["Valor Unit√°rio"] || 0),
                            Valor_Total: parseFloat(c.Valor_Total || c["Valor Total"] || 0),
                            Unidade: String(c.Unidade || c["Unidade"] || ''),
                            Fornecedor: String(c.Fornecedor || c["Fornecedor"] || ''),
                            Observacoes: String(c.Observacoes || c["Observa√ß√µes"] || '')
                        };
                    });
                    
                    renderCustos();
                } else {
                    console.error('Erro na resposta da API de custos:', json.error || 'Resposta inv√°lida');
                    todosOsCustos = [];
                    renderCustos();
                }
            } catch (error) {
                console.error('Erro ao buscar custos:', error);
                todosOsCustos = [];
                renderCustos();
            }
        }

        function renderCustos() {
            const container = document.getElementById('custos-container');
            if (!container) return;
            
            const searchValue = (document.getElementById('search-filter-custos')?.value || '').trim().toLowerCase();
            const dateFilterValue = document.getElementById('date-filter-custos')?.value || '';
            
            let custosVisiveis = todosOsCustos.filter(c => {
                // Filtro de busca por nome do item
                if (searchValue) {
                    const nomeMatch = (c.Nome_Item || '').toLowerCase().includes(searchValue);
                    if (!nomeMatch) return false;
                }
                
                // Filtro de data (mesma l√≥gica dos pedidos)
                if (dateFilterValue) {
                    const [fYear, fMonth, fDay] = dateFilterValue.split('-');
                    const dateParts = String(c.Data || '').match(/(\d{2})\/(\d{2})\/(\d{4})/);
                    
                    if (dateParts) {
                        const pDay = dateParts[1];
                        const pMonth = dateParts[2];
                        const pYear = dateParts[3];
                        
                        if (fDay === '01') {
                            return pMonth === fMonth && pYear === fYear;
                        } else {
                            return pDay === fDay && pMonth === fMonth && pYear === fYear;
                        }
                    }
                    return true;
                }
                
                return true;
            });
            
            // Ordena por data (mais recente primeiro)
            custosVisiveis.sort((a, b) => {
                const dateA = a.Data_para_Input ? new Date(a.Data_para_Input) : new Date(0);
                const dateB = b.Data_para_Input ? new Date(b.Data_para_Input) : new Date(0);
                return dateB - dateA;
            });
            
            // Calcula total geral
            const totalGeral = custosVisiveis.reduce((sum, c) => sum + (c.Valor_Total || 0), 0);
            
            if (custosVisiveis.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #1A2B0F; font-size: 18px; background-color: #F4E6CB; border-radius: 8px;">
                        ${searchValue || dateFilterValue ? 'Nenhum custo encontrado com os filtros aplicados.' : 'Nenhum custo encontrado.'}
                    </div>
                `;
                return;
            }
            
            let html = '<div style="margin-bottom: 20px;">';
            
            custosVisiveis.forEach(custo => {
                html += `
                    <div class="custo-item">
                        <div class="custo-item-header">
                            <div class="custo-item-nome">${custo.Nome_Item || 'Sem nome'}</div>
                            <div class="custo-item-data">${custo.Data || 'Sem data'}</div>
                        </div>
                        <div class="custo-item-detalhes">
                            ${custo.Quantidade ? `
                                <div class="custo-detalhe">
                                    <span class="custo-detalhe-label">Quantidade:</span>
                                    <span class="custo-detalhe-valor">${custo.Quantidade} ${custo.Unidade || ''}</span>
                                </div>
                            ` : ''}
                            ${custo.Valor_Unitario ? `
                                <div class="custo-detalhe">
                                    <span class="custo-detalhe-label">Valor Unit√°rio:</span>
                                    <span class="custo-detalhe-valor">R$ ${custo.Valor_Unitario.toFixed(2).replace('.', ',')}</span>
                                </div>
                            ` : ''}
                            ${custo.Valor_Total ? `
                                <div class="custo-detalhe">
                                    <span class="custo-detalhe-label">Valor Total:</span>
                                    <span class="custo-detalhe-valor">R$ ${custo.Valor_Total.toFixed(2).replace('.', ',')}</span>
                                </div>
                            ` : ''}
                            ${custo.Fornecedor ? `
                                <div class="custo-detalhe">
                                    <span class="custo-detalhe-label">Fornecedor:</span>
                                    <span class="custo-detalhe-valor">${custo.Fornecedor}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${custo.Observacoes ? `
                            <div style="margin-top: 10px; padding: 8px; background-color: #E8D5B5; border-radius: 5px; font-size: 0.9em; color: #555;">
                                <strong>Observa√ß√µes:</strong> ${custo.Observacoes}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                <div class="custo-total">
                    <div class="custo-total-label">Total Geral:</div>
                    <div class="custo-total-valor">R$ ${totalGeral.toFixed(2).replace('.', ',')}</div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        /**
         * Fun√ß√£o para renderizar o quadro Kanban e os cards
         * Vers√£o robusta com filtro flex√≠vel
         */
        function renderKanban() {
            const kanbanBoard = document.getElementById('kanban-board');
            kanbanBoard.innerHTML = '';
            const dateFilterValue = document.getElementById('date-filter').value; // Formato YYYY-MM-DD
            const searchValue = document.getElementById('search-filter').value.trim().toLowerCase(); // Busca

            let pedidosVisiveis = [];

            KANBAN_STATUSES.forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.status = status; 
                // No mobile, desabilita drag and drop
                if (window.innerWidth > 768) {
                column.addEventListener('dragover', dragOver);
                column.addEventListener('drop', drop);
                column.addEventListener('dragleave', dragLeave);
                }

                const header = document.createElement('div');
                header.className = 'column-header';
                
                // FILTRAGEM ROBUSTA (case-insensitive)
                const pedidosNaColuna = todosOsPedidos.filter(p => {
                    const statusPedido = p.Status_do_Pedido || p.Status || '';
                    const statusMatch = statusEquals(statusPedido, status);
                    if (!statusMatch) return false;

                    // Filtro de busca (ID, nome e n√∫mero do cliente)
                    if (searchValue) {
                        const idMatch = (p.ID_do_Pedido || '').toLowerCase().includes(searchValue);
                        const nomeMatch = (p.Nome_Cliente || '').toLowerCase().includes(searchValue);
                        const numeroMatch = (p.Numero || '').toLowerCase().includes(searchValue);
                        
                        if (!idMatch && !nomeMatch && !numeroMatch) {
                            return false;
                        }
                    }

                    // Filtro de data (permite filtrar por dia espec√≠fico, m√™s/ano, ou intervalo)
                    if (dateFilterValue) {
                        const dateFilterInicial = document.getElementById('date-filter-inicial').value;
                        
                        // Extrai a data do pedido (DD/MM/YYYY)
                        const dateParts = String(p.Data_Entrega || p.Data_da_Entrega || '').match(/(\d{2})\/(\d{2})\/(\d{4})/);

                        if (dateParts) {
                            const pDay = parseInt(dateParts[1]);
                            const pMonth = parseInt(dateParts[2]);
                            const pYear = parseInt(dateParts[3]);
                            
                            // Se houver data inicial (segunda sele√ß√£o), filtra por intervalo
                            if (dateFilterInicial && dateFilterInicial !== dateFilterValue) {
                                const pedidoDate = new Date(pYear, pMonth - 1, pDay);
                                const [iniYear, iniMonth, iniDay] = dateFilterInicial.split('-').map(Number);
                                const [finYear, finMonth, finDay] = dateFilterValue.split('-').map(Number);
                                
                                const dataInicial = new Date(iniYear, iniMonth - 1, iniDay);
                                const dataFinal = new Date(finYear, finMonth - 1, finDay);
                                
                                // Verifica se a data do pedido est√° dentro do intervalo (inclusive)
                                return pedidoDate >= dataInicial && pedidoDate <= dataFinal;
                            }
                            // Filtro normal (uma data apenas)
                            else {
                                const [fYear, fMonth, fDay] = dateFilterValue.split('-').map(Number);
                                
                                // Se o dia selecionado for 01, filtra apenas por m√™s/ano (filtro padr√£o)
                                if (fDay === 1) {
                                    // Filtra apenas por m√™s e ano
                                    return pMonth === fMonth && pYear === fYear;
                                } else {
                                    // Filtra por dia, m√™s e ano espec√≠ficos
                                    return pDay === fDay && pMonth === fMonth && pYear === fYear;
                                }
                            }
                        }
                        return true; // Se a data estiver mal formatada, mostra o pedido em vez de esconder
                    }
                    
                    return true; // Se n√£o houver filtro de data, mostra tudo
                });

                // Ordena os pedidos por data e hor√°rio de entrega (mais antigo primeiro)
                pedidosNaColuna.sort((a, b) => {
                    const dateA = a.sortDate || new Date(0);
                    const dateB = b.sortDate || new Date(0);
                    return dateA - dateB;
                });

                pedidosVisiveis.push(...pedidosNaColuna);
                
                // Cria container para o texto do header
                const headerText = document.createElement('span');
                headerText.className = 'column-header-text';
                headerText.textContent = `${status} (${pedidosNaColuna.length})`;
                
                // Cria checkbox de selecionar todos
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.className = 'column-select-all-checkbox';
                selectAllCheckbox.title = 'Selecionar todos os itens desta etapa';
                selectAllCheckbox.onchange = (e) => {
                    e.stopPropagation(); // Previne que o clique feche/abra a coluna no mobile
                    if (selectAllCheckbox.checked) {
                        selectAllInColumn(column);
                    } else {
                        deselectAllInColumn(column);
                    }
                };
                
                header.appendChild(selectAllCheckbox);
                header.appendChild(headerText);
                
                // Adiciona funcionalidade de collapse no mobile
                if (window.innerWidth <= 768) {
                    // No mobile, todas as colunas come√ßam fechadas
                    column.classList.add('collapsed');
                    header.classList.add('collapsed');
                    
                    // Apenas o texto do header abre/fecha (n√£o o bot√£o)
                    headerText.addEventListener('click', () => {
                        // Fecha todas as outras colunas
                        document.querySelectorAll('.kanban-column').forEach(col => {
                            if (col !== column) {
                                col.classList.add('collapsed');
                                col.querySelector('.column-header').classList.add('collapsed');
                            }
                        });
                        // Toggle da coluna atual
                        column.classList.toggle('collapsed');
                        header.classList.toggle('collapsed');
                    });
                }
                
                column.appendChild(header);

                // Cria container para os cards (para anima√ß√£o de collapse)
                const columnContent = document.createElement('div');
                columnContent.className = 'column-content';
                
                pedidosNaColuna.forEach(pedido => {
                    columnContent.appendChild(createPedidoCard(pedido));
                });
                
                column.appendChild(columnContent);
                kanbanBoard.appendChild(column);
            });
            
            updateDashboardTotals(pedidosVisiveis); 
        }
        
        /**
         * Recebe apenas a lista de pedidos VIS√çVEIS (filtrados).
         * Se houver tickets selecionados, mostra o total dos selecionados.
         * Caso contr√°rio, mostra o total do m√™s vigente (como antes).
         */
        function updateDashboardTotals(pedidosVisiveis) {
            let totalLiquidoGeral = 0;
            let totalPedidosContados = 0;
            
            const statusToCount = ['Pedido Recebido', 'Pedido Confirmado', 'Aguardando Retirada', 'Entregue'];
            const dateFilterValue = document.getElementById('date-filter')?.value; // YYYY-MM-DD
            const dateFilterInicial = document.getElementById('date-filter-inicial')?.value; // YYYY-MM-DD ou vazio
            
            // Helper para parsear data do pedido (DD/MM/YYYY)
            const parseDataPedido = (pedido) => {
                const parts = String(pedido.Data_Entrega || pedido.Data_da_Entrega || '').match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (!parts) return null;
                const day = parseInt(parts[1], 10);
                const month = parseInt(parts[2], 10) - 1;
                const year = parseInt(parts[3], 10);
                return new Date(year, month, day);
            };
            
            // Determina janela de datas para somar quando n√£o houver filtro expl√≠cito
            const montarRangePadraoMesVigente = () => {
                const hoje = new Date();
                const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                return { inicio, fim };
            };
            
            // Decide quais pedidos entram no c√°lculo:
            // 1) Se houver tickets selecionados: apenas selecionados
            // 2) Se existir filtro de data: usa os pedidosVisiveis (j√° filtrados)
            // 3) Sem sele√ß√£o e sem filtro: usa apenas pedidos do m√™s vigente
            let pedidosParaSomar = [];
            
            if (selectedTickets && selectedTickets.size > 0) {
                selectedTickets.forEach(id => {
                    const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === id);
                    if (pedido) pedidosParaSomar.push(pedido);
                });
            } else if (dateFilterValue) {
                pedidosParaSomar = pedidosVisiveis; // j√° respeita o filtro de data aplicado na tela
            } else {
                const { inicio, fim } = montarRangePadraoMesVigente();
                pedidosParaSomar = pedidosVisiveis.filter(p => {
                    const data = parseDataPedido(p);
                    if (!data) return false;
                    return data >= inicio && data <= fim;
                });
            }
            
            pedidosParaSomar.forEach(p => {
                const total = parseFloat(p.Total_Final || 0); 
                const statusAtual = p.Status_do_Pedido || p.Status || '';
                const deveContar = statusToCount.some(status => statusEquals(statusAtual, status));
                if (deveContar) {
                    totalLiquidoGeral += total;
                    totalPedidosContados++;
                }
            });

            document.querySelector('#dashboard-totals strong').textContent = `R$ ${totalLiquidoGeral.toFixed(2).replace('.', ',')}`;
            document.getElementById('total-pedidos').textContent = `${totalPedidosContados} ${totalPedidosContados === 1 ? 'pedido' : 'pedidos'}`;
        }

        function createPedidoCard(pedido) {
            const card = document.createElement('div');
            const statusAtual = normalizeStatus(pedido.Status_do_Pedido || pedido.Status || 'Pedido Recebido');
            const sanitizedStatus = statusAtual.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').trim('-'); 

            // No mobile, desabilita drag and drop (usa select de status)
            if (window.innerWidth > 768) {
            card.setAttribute('draggable', true);
            }
            card.dataset.id = pedido.ID_do_Pedido;

            const total = parseFloat(pedido.Total_Final || 0).toFixed(2).replace('.', ',');
            
            // Usa os campos mapeados no fetchPedidos
            const data = pedido.Data_Entrega || 'N/A'; // DD/MM/AAAA
            // Hor√°rio j√° vem limpo como string HH:mm do fetchPedidos - usa diretamente sem convers√£o
            const hora = pedido.Horario_Entrega || '00:00'; 

            const nomeCliente = pedido.Nome_Cliente || 'N/A';
            const statusPagamento = pedido.Status_Pagamento || 'Pendente';
            const temObservacoes = pedido.Observacoes && pedido.Observacoes.trim() !== '';
            
            // Adiciona classe de cor de fundo baseada no status de pagamento
            let classePagamento = '';
            if (statusPagamento === 'Pago 50%' || statusPagamento === 'PAGO 50%' || statusPagamento === '50%' || statusPagamento === '50') {
                classePagamento = 'pagamento-50';
            } else if (statusPagamento === 'Pago 100%' || statusPagamento === 'PAGO 100%' || statusPagamento === 'Pago' || statusPagamento === 'PAGO') {
                classePagamento = 'pagamento-pago';
            } else {
                classePagamento = 'pagamento-pendente';
            }
            
            // Define as classes do card (status do pedido)
            // Adiciona classe para observa√ß√µes se houver
            const classeObservacao = temObservacoes ? ' com-observacao' : '';
            card.className = `pedido-card status-${sanitizedStatus}${classeObservacao}`;

            // Cria op√ß√µes do select de status de etapa
            const statusOptions = KANBAN_STATUSES.map(s => 
                `<option value="${s}" ${statusEquals(statusAtual, s) ? 'selected' : ''}>${s}</option>`
            ).join('');

            card.innerHTML = `
                <input type="checkbox" class="card-checkbox" data-pedido-id="${pedido.ID_do_Pedido}" onchange="toggleTicketSelection(this)">
                <br>
                <div class="card-id">${pedido.ID_do_Pedido}${temObservacoes ? ' <span class="card-obs-badge">‚ö†Ô∏è OBS</span>' : ''}</div>
                ${temObservacoes ? '<div class="card-observacao-alerta">‚ö†Ô∏è Possui Observa√ß√£o</div>' : ''}
                <div class="card-title">${nomeCliente}</div>
                <div class="card-detail"><strong>Data de entrega:</strong> ${data}</div>
                <div class="card-detail"><strong>Hor√°rio de entrega:</strong> ${hora}</div>
                <div class="card-detail"><strong>Total do valor:</strong> R$ ${total}</div>
                <div class="card-status-etapa">
                    <label>Status da Etapa:</label>
                    <select class="status-etapa-select" data-pedido-id="${pedido.ID_do_Pedido}" onchange="atualizarStatusEtapaMobile(this)">
                        ${statusOptions}
                    </select>
                </div>
                <div class="card-status-pagamento ${classePagamento}">
                    <label>Status do Pagamento:</label>
                    <select class="status-pagamento-select" data-pedido-id="${pedido.ID_do_Pedido}" onchange="atualizarStatusPagamento(this)">
                        <option value="Pendente" ${statusPagamento === 'Pendente' || statusPagamento === 'PENDENTE' ? 'selected' : ''}>Pendente</option>
                        <option value="Pago 50%" ${statusPagamento === 'Pago 50%' || statusPagamento === 'PAGO 50%' || statusPagamento === '50%' || statusPagamento === '50' ? 'selected' : ''}>Pago 50%</option>
                        <option value="Pago 100%" ${statusPagamento === 'Pago 100%' || statusPagamento === 'PAGO 100%' || statusPagamento === 'Pago' || statusPagamento === 'PAGO' ? 'selected' : ''}>Pago 100%</option>
                    </select>
                </div>
            `;

            card.addEventListener('dragstart', dragStart);
            // Corrige o conflito de clique/drag:
            card.addEventListener('click', (e) => {
                 // N√£o abre o modal se clicar no select, label ou checkbox
                 if (e.target.tagName !== 'SELECT' && e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT' && !e.target.closest('.card-status-etapa') && !e.target.closest('.card-status-pagamento') && !e.target.closest('.card-checkbox')) {
                 e.stopPropagation(); 
                 showModal(pedido.ID_do_Pedido);
                 }
            }); 

            // Previne que o select interfira no drag and drop
            const selectElement = card.querySelector('.status-pagamento-select');
            if (selectElement) {
                selectElement.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
                selectElement.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            }

            // Previne que o select de status de etapa interfira no drag and drop
            const selectEtapaElement = card.querySelector('.status-etapa-select');
            if (selectEtapaElement) {
                selectEtapaElement.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
                selectEtapaElement.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            }

            return card;
        }

        // =========================================================================
        // DRAG AND DROP E MODAL (L√ìGICA)
        // =========================================================================

        function dragStart(e) { e.dataTransfer.setData('text/plain', e.target.dataset.id); e.target.classList.add('dragging'); }
        function dragOver(e) { e.preventDefault(); const column = e.currentTarget; column.classList.add('over'); }
        function dragLeave(e) { e.currentTarget.classList.remove('over'); }
        
        async function drop(e) {
            e.preventDefault();
            const column = e.currentTarget;
            const newStatus = column.dataset.status;
            const pedidoId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.querySelector(`.dragging[data-id="${pedidoId}"]`);

            column.classList.remove('over');
            
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                column.appendChild(draggedCard);
            }
            
            await updatePedidoStatus(pedidoId, newStatus);
        }

        // Fun√ß√£o para exibir toast de notifica√ß√£o
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#E60000' : '#2ecc71';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    toast.style.animation = '';
                }, 300);
            }, 3000);
        }

        // Fun√ß√£o para adicionar requisi√ß√£o √† fila
        async function addToQueue(formData) {
            requestQueue.push(formData);
            if (!isProcessingQueue) {
                processQueue();
            }
        }

        // Fun√ß√£o para processar a fila de requisi√ß√µes sequencialmente
        async function processQueue() {
            // Se a fila est√° vazia, libera e retorna
            if (requestQueue.length === 0) {
                isProcessingQueue = false;
                // Libera refresh autom√°tico ap√≥s 8 segundos de sil√™ncio na fila
                setTimeout(() => {
                    isUpdating = false;
                }, 8000);
                return;
            }
            
            // Define flags de processamento
            isProcessingQueue = true;
            isUpdating = true;
            
            // Remove o primeiro item da fila
            const currentRequest = requestQueue.shift();
            
            try {
                // Aguarda o fetch completar - Envia JSON bruto com header espec√≠fico
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(currentRequest)
                });
                console.log("Sincronizado com a planilha");
            } catch (e) {
                console.error("Erro na fila:", e);
            }
            
            // Espera 500ms antes do pr√≥ximo para estabilidade
            setTimeout(processQueue, 500);
        }

        async function updatePedidoStatus(id, status) {
            // Normaliza o status para garantir consist√™ncia (case-insensitive)
            const statusNormalizado = normalizeStatus(status);
            
            // 1. L√ìGICA OTIMISTA - Atualiza o dado na mem√≥ria do site (PRIMEIRA LINHA)
            const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === id);
            if (pedido) {
                pedido.Status_do_Pedido = statusNormalizado;
                pedido.Status = statusNormalizado; // Mant√©m compatibilidade
            }
            
            // 2. Muda a tela na hora (renderiza√ß√£o local imediata)
            renderKanban();
            showToast('Salvo!');
            
            // 3. Adiciona √† fila de requisi√ß√µes - Usa objeto JavaScript simples
            const payload = {
                action: 'updateStatus',
                id: id,
                Status_do_Pedido: statusNormalizado
            };
            
            addToQueue(payload); // Adiciona √† fila e processa
        }

        async function atualizarStatusPagamento(selectElement) {
            const pedidoId = selectElement.dataset.pedidoId;
            // Garante que o value seja exatamente o texto selecionado (Pendente, Pago 50% ou Pago 100%)
            const novoStatus = String(selectElement.value).trim();
            
            // 1. L√ìGICA OTIMISTA - Atualiza o dado na mem√≥ria do site (PRIMEIRA LINHA)
            const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === pedidoId);
            if (!pedido) {
                showToast("Erro: Pedido n√£o encontrado.", true);
                return;
            }
            
            // Atualiza o status de pagamento no array local
            pedido.Status_Pagamento = novoStatus;
            
            // 2. Muda a tela na hora (renderiza√ß√£o local imediata)
            renderKanban();
            showToast('Salvo!');
            
            // 3. Adiciona √† fila de requisi√ß√µes - Usa objeto JavaScript simples
            // Formata Total_Final com v√≠rgula decimal
            const totalFormatado = String(pedido.Total_Final || '').replace('.', ',');
            
            const payload = {
                action: 'updateData',
                id: pedidoId,
                ID_do_Pedido: pedidoId,
                Nome_Cliente: pedido.Nome_Cliente || '',
                Numero: pedido.Numero || '',
                Data_Entrega: "'" + (pedido.Data_Entrega || ''), // Adiciona aspa simples para for√ßar texto
                Horario_Entrega: "'" + (pedido.Horario_Entrega || ''), // Adiciona aspa simples para for√ßar texto
                Total_Final: totalFormatado, // Com v√≠rgula decimal
                Forma_de_Pagamento: pedido.Forma_de_Pagamento || '',
                Status_Pagamento: novoStatus,
                Cupom: pedido.Cupom || '',
                Resumo_dos_Itens: pedido.Resumo_dos_Itens || '',
                Status_do_Pedido: pedido.Status_do_Pedido || ''
            };
            
            // Adiciona Observacoes se existir
            if (pedido.Observacoes !== undefined) {
                payload.Observacoes = String(pedido.Observacoes || '');
            }
            
            addToQueue(payload); // Adiciona √† fila e processa
        }

        // Fun√ß√£o para atualizar status de etapa via select no mobile
        async function atualizarStatusEtapaMobile(selectElement) {
            const pedidoId = selectElement.dataset.pedidoId;
            const novoStatus = String(selectElement.value).trim();
            const statusNormalizado = normalizeStatus(novoStatus);
            
            // Usa a mesma l√≥gica do updatePedidoStatus
            await updatePedidoStatus(pedidoId, statusNormalizado);
        }
        
        // MODAL FUNCTIONS
        const modal = document.getElementById('modal');
        const editForm = document.getElementById('edit-form');

        function showModal(id) {
            
            const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === id);
            if (!pedido) {
                 console.error("Pedido n√£o encontrado para o ID:", id);
                 return;
            }

            pedidoSendoEditado = pedido; 
            
            // Exibi√ß√£o - usa os campos mapeados corretamente
            const totalNum = parseFloat(pedido.Total_Final || 0);
            const totalFormatado = totalNum.toFixed(2).replace('.', ',');
            
            // Usa os campos mapeados no fetchPedidos
            const data = pedido.Data_Entrega || 'N/A';
            // Hor√°rio j√° vem limpo como string HH:mm do fetchPedidos - usa diretamente
            const hora = pedido.Horario_Entrega || '00:00';
            const dataHora = `${data} √†s ${hora}`;
            
            // Preenche o cabe√ßalho e detalhes - usa os campos mapeados
            const nomeCliente = pedido.Nome_Cliente || 'N/A';
            const cupom = pedido.Cupom || 'N/A';
            const statusPagamento = pedido.Status_Pagamento || 'PENDENTE';
            
            document.getElementById('pedido-id').textContent = id;
            document.getElementById('detail-nome').textContent = nomeCliente;
            // Sincroniza√ß√£o do Modal - usa o campo correto pedido.Numero
            // Garante que n√£o exiba "N/A" - se vazio, exibe string vazia
            const numeroDisplay = (pedido.Numero && pedido.Numero.trim() !== '' && pedido.Numero.trim() !== 'N/A') ? pedido.Numero : '';
            document.getElementById('detail-numero').textContent = numeroDisplay || '';
            document.getElementById('detail-data').textContent = data;
            document.getElementById('detail-horario').textContent = hora;
            document.getElementById('detail-pagamento').textContent = pedido.Forma_de_Pagamento || pedido.Forma_Pagamento || 'N/A';
            document.getElementById('detail-status-pagamento').textContent = statusPagamento;
            document.getElementById('detail-cupom').textContent = cupom;
            document.getElementById('detail-total-final').textContent = `R$ ${totalFormatado}`;
            document.getElementById('detail-resumo-itens').textContent = extractResumoItens(pedido.Resumo_dos_Itens || '');
            
            // Exibe Observa√ß√µes se existirem
            const observacoes = pedido.Observacoes || '';
            const observacoesGroup = document.getElementById('detail-observacoes-group');
            if (observacoes && observacoes.trim() !== '') {
                document.getElementById('detail-observacoes').textContent = observacoes;
                observacoesGroup.style.display = 'block';
            } else {
                observacoesGroup.style.display = 'none';
            }

            // Preenche o formul√°rio de edi√ß√£o usando os campos mapeados
            document.getElementById('edit-nome').value = nomeCliente;
            // Garante que o campo Numero mostre campo limpo se for 'N/A' ou vazio
            const numeroParaInput = (pedido.Numero && pedido.Numero.trim() !== '' && pedido.Numero.trim() !== 'N/A') ? pedido.Numero : '';
            document.getElementById('edit-numero').value = numeroParaInput;
            document.getElementById('edit-data').value = pedido.Data_Entrega || ''; // DD/MM/AAAA - usa campo mapeado
            
            // Tratamento de Hor√°rio no Carregamento - Hor√°rio j√° vem limpo do fetchPedidos
            // Usa diretamente o valor j√° formatado como string HH:mm
            const horarioParaInput = pedido.Horario_Entrega || '00:00';
            document.getElementById('edit-horario').value = horarioParaInput; // HH:MM formatado
            document.getElementById('edit-pagamento').value = pedido.Forma_de_Pagamento || pedido.Forma_Pagamento || 'Pix';
            document.getElementById('edit-status-pagamento').value = statusPagamento;
            document.getElementById('edit-cupom').value = cupom;
            document.getElementById('edit-total').value = totalNum.toFixed(2); 
            
            // O Resumo √© preenchido, mas √© readonly
            document.getElementById('edit-resumo').value = pedido.Resumo_dos_Itens;
            
            modal.style.display = 'flex'; // Torna o modal vis√≠vel
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        }

        function closeModal() {
            modal.style.display = 'none';
            pedidoSendoEditado = null;
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        }

        // Fun√ß√£o para alternar entre as abas
        function switchMainTab(tabName) {
            // Remove a classe active de todos os bot√µes e conte√∫dos
            document.querySelectorAll('.main-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Adiciona a classe active ao bot√£o e conte√∫do selecionados
            const button = document.querySelector(`.main-tab-button[onclick="switchMainTab('${tabName}')"]`);
            const content = document.getElementById(`main-tab-${tabName}`);
            
            if (button) button.classList.add('active');
            if (content) content.classList.add('active');
            
            // Carrega dados quando a aba √© aberta
            if (tabName === 'custos') {
                fetchCustos();
            }
        }
        
        function switchTab(tabName) {
            // Remove active de todos os bot√µes e pain√©is
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            // Ativa o bot√£o e painel selecionados
            const button = document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`);
            const pane = document.getElementById(`tab-${tabName}`);
            
            if (button) button.classList.add('active');
            if (pane) pane.classList.add('active');
        }

        document.getElementById('edit-button').addEventListener('click', () => {
            document.getElementById('modal-details').style.display = 'none';
            document.querySelector('.modal-actions').style.display = 'none';
            editForm.style.display = 'block';
        });

        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('modal-details').style.display = 'block';
            document.querySelector('.modal-actions').style.display = 'block';
            editForm.style.display = 'none';
        });
        
        // Adiciona o evento de submiss√£o do formul√°rio de edi√ß√£o
        editForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             await updatePedidoData();
        });


        function openCalculatorModal() {
            if (!CALCULATOR_URL) {
                 alert("URL do calculador n√£o configurada. Defina a constante CALCULATOR_URL no c√≥digo.");
                 return;
            }
            document.getElementById('calculator-iframe').src = CALCULATOR_URL;
            document.getElementById('calculator-modal').style.display = 'flex';
        }
        
        function closeCalculatorModal(event) {
             // Fecha apenas se o clique for no fundo do modal
             if (event.target.id === 'calculator-modal') {
                document.getElementById('calculator-iframe').src = '';
                document.getElementById('calculator-modal').style.display = 'none';
             }
        }
        
        async function updatePedidoData() {
            // 1. BLOQUEIO DE REFRESH - Define isUpdating = true no in√≠cio
            isUpdating = true;
            
            // 2. CAPTURA IMEDIATA - Captura todos os valores dos campos do formul√°rio
            const nomeToSheet = document.getElementById('edit-nome').value.trim();
            const numeroToSheet = document.getElementById('edit-numero').value.trim();
            const dataToSheet = document.getElementById('edit-data').value.trim(); // DD/MM/AAAA
            
            // Tratamento de Hor√°rio no Salvamento - For√ßa o hor√°rio a ser apenas texto HH:mm
            const h = String(document.getElementById('edit-horario').value).substring(0, 5);
            const horarioParaEnviar = h;
            
            const pagamentoToSheet = document.getElementById('edit-pagamento').value;
            const statusPagamentoToSheet = document.getElementById('edit-status-pagamento').value;
            const cupomToSheet = document.getElementById('edit-cupom').value.trim();
            const totalToSheet = document.getElementById('edit-total').value;
            
            // Status do Pedido n√£o √© edit√°vel - mant√©m o valor atual do pedido
            const statusToSheet = pedidoSendoEditado.Status_do_Pedido || pedidoSendoEditado.Status || 'Pedido Recebido';
            
            // 3. SINCRONIZA√á√ÉO LOCAL (OTIMISTA) - Localiza o pedido e atualiza todos os campos
            const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === pedidoSendoEditado.ID_do_Pedido);
            if (!pedido) {
                isUpdating = false;
                showToast('Erro: Pedido n√£o encontrado.', true);
                return;
            }
            
            // Atualiza todos os campos do pedido no array local com hor√°rio formatado
            pedido.Nome_Cliente = nomeToSheet;
            pedido.Numero = String(numeroToSheet || '');
            pedido.Data_Entrega = String(dataToSheet || '');
            pedido.Horario_Entrega = horarioParaEnviar; // Usa hor√°rio formatado
            pedido.Total_Final = totalToSheet;
            pedido.Forma_de_Pagamento = pagamentoToSheet;
            pedido.Status_Pagamento = statusPagamentoToSheet;
            pedido.Cupom = cupomToSheet;
            pedido.Status_do_Pedido = statusToSheet;
            pedido.Status = statusToSheet; // Mant√©m compatibilidade
            // Preserva Observacoes se existir (n√£o h√° campo de edi√ß√£o, ent√£o mant√©m o valor atual)
            if (pedidoSendoEditado.Observacoes !== undefined) {
                pedido.Observacoes = pedidoSendoEditado.Observacoes;
            }
            
            // Atualiza campos auxiliares para ordena√ß√£o e filtros
            const dataParaInput = formatDDMMYYYYtoYYYYMMDD(dataToSheet);
            pedido.Data_para_Input = dataParaInput;
            
            // Atualiza sortDate para ordena√ß√£o usando hor√°rio formatado
            let sortDate = new Date(0);
            if (dataParaInput) {
                try {
                    const horaParaOrdenacao = horarioParaEnviar || '00:00';
                    sortDate = new Date(`${dataParaInput.replace(/-/g, '/')} ${horaParaOrdenacao}`);
                    if (isNaN(sortDate.getTime())) {
                        sortDate = new Date(0);
                    }
                } catch(e) {
                    sortDate = new Date(0);
                }
            }
            pedido.sortDate = sortDate;
            
            // 4. REFLEXO VISUAL IMEDIATO - Renderiza e fecha o modal instantaneamente
            renderKanban();
            showToast('Salvo!');
            closeModal();
            
            // 5. ENVIO EM FUNDO (FILA) - Monta payload como objeto JavaScript simples
            // Formata Total_Final com v√≠rgula decimal
            const totalFormatado = String(totalToSheet).replace('.', ',');
            
            const payload = {
                action: 'updateData',
                id: pedidoSendoEditado.ID_do_Pedido,
                ID_do_Pedido: pedidoSendoEditado.ID_do_Pedido,
                Nome_Cliente: nomeToSheet,
                Numero: String(numeroToSheet || ''),
                Data_Entrega: "'" + dataToSheet, // Adiciona aspa simples para for√ßar texto no Sheets
                Horario_Entrega: "'" + horarioParaEnviar, // Adiciona aspa simples para for√ßar texto no Sheets
                Total_Final: totalFormatado, // Com v√≠rgula decimal
                Forma_de_Pagamento: pagamentoToSheet,
                Status_Pagamento: statusPagamentoToSheet,
                Cupom: cupomToSheet,
                Status_do_Pedido: pedidoSendoEditado.Status_do_Pedido
            };
            
            // Adiciona Observacoes se existir no pedido
            if (pedidoSendoEditado.Observacoes !== undefined) {
                payload.Observacoes = String(pedidoSendoEditado.Observacoes || '');
            }
            
            // 6. ENVIO SILENCIOSO VIA FILA
            addToQueue(payload);
            // Bloqueia refresh autom√°tico por 8 segundos
            setTimeout(() => { isUpdating = false; }, 8000);
        }



        // =========================================================================
        // INICIALIZA√á√ÉO E EVENTOS
        // =========================================================================

        // Fun√ß√£o para atualizar o display da data no formato brasileiro
        function atualizarDisplayData() {
            const dateFilterInput = document.getElementById('date-filter');
            const dateFilterInicial = document.getElementById('date-filter-inicial');
            const dateFilterDisplay = document.getElementById('date-filter-display');
            
            if (dateFilterInput.value) {
                const [ano, mes, dia] = dateFilterInput.value.split('-');
                
                // Se houver data inicial e for diferente da final, mostra intervalo
                if (dateFilterInicial.value && dateFilterInicial.value !== dateFilterInput.value) {
                    const [iniAno, iniMes, iniDia] = dateFilterInicial.value.split('-');
                    dateFilterDisplay.value = `${iniDia}/${iniMes}/${iniAno} at√© ${dia}/${mes}/${ano}`;
                } else {
                    // Se for dia 01, mostra apenas MM/AAAA
                    if (dia === '01') {
                        dateFilterDisplay.value = `${mes}/${ano}`;
                    } else {
                        // Se for outro dia, mostra DD/MM/AAAA
                        dateFilterDisplay.value = `${dia}/${mes}/${ano}`;
                    }
                }
            } else {
                dateFilterDisplay.value = '';
            }
        }

        // Vari√°veis globais para o calend√°rio
        let currentCalendarDate = new Date();
        let selectedDate = null;

        // Fun√ß√£o para renderizar o calend√°rio
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearDisplay = document.getElementById('month-year-display');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            // Primeiro dia do m√™s
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Dias da semana
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            
            calendarGrid.innerHTML = '';
            
            // Adiciona cabe√ßalhos dos dias da semana
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'date-picker-weekday';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Adiciona c√©lulas vazias para os dias do m√™s anterior
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'date-picker-day other-month';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Adiciona os dias do m√™s
            const hoje = new Date();
            const dateFilterInput = document.getElementById('date-filter');
            const dateFilterInicial = document.getElementById('date-filter-inicial');
            const currentValue = dateFilterInput.value ? new Date(dateFilterInput.value + 'T00:00:00') : null;
            const initialValue = dateFilterInicial.value ? new Date(dateFilterInicial.value + 'T00:00:00') : null;
            
            // Verifica se h√° intervalo selecionado
            const hasInterval = initialValue && currentValue && initialValue.getTime() !== currentValue.getTime();
            const dataInicial = hasInterval ? initialValue : null;
            const dataFinal = hasInterval ? currentValue : null;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'date-picker-day';
                dayElement.textContent = day;
                
                const cellDate = new Date(year, month, day);
                
                // Marca o dia de hoje
                if (cellDate.toDateString() === hoje.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Marca intervalo selecionado
                if (hasInterval && dataInicial && dataFinal) {
                    const cellTime = cellDate.getTime();
                    const iniTime = dataInicial.getTime();
                    const finTime = dataFinal.getTime();
                    
                    if (cellTime === iniTime) {
                        dayElement.classList.add('selected', 'range-start');
                    } else if (cellTime === finTime) {
                        dayElement.classList.add('selected', 'range-end');
                    } else if (cellTime > iniTime && cellTime < finTime) {
                        dayElement.classList.add('range-middle');
                    }
                } else if (currentValue && cellDate.toDateString() === currentValue.toDateString()) {
                    // Marca o dia selecionado (quando n√£o h√° intervalo)
                    dayElement.classList.add('selected');
                }
                
                dayElement.addEventListener('click', () => {
                    selectDate(year, month, day);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Fun√ß√£o para selecionar uma data (suporta intervalo)
        function selectDate(year, month, day) {
            const dateFilterInput = document.getElementById('date-filter');
            const dateFilterInicial = document.getElementById('date-filter-inicial');
            const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // Se n√£o h√° data inicial, define como inicial
            if (!dateFilterInicial.value) {
                dateFilterInicial.value = formattedDate;
                dateFilterInput.value = formattedDate;
            } else {
                const dataInicial = new Date(dateFilterInicial.value + 'T00:00:00');
                const dataSelecionada = new Date(formattedDate + 'T00:00:00');
                
                // Se a data selecionada √© anterior √† inicial, substitui a inicial
                if (dataSelecionada < dataInicial) {
                    dateFilterInicial.value = formattedDate;
                    dateFilterInput.value = formattedDate;
                } else if (dataSelecionada.getTime() === dataInicial.getTime()) {
                    // Se clicar na mesma data, limpa o intervalo (filtra apenas essa data)
                    dateFilterInicial.value = '';
                    dateFilterInput.value = formattedDate;
                } else {
                    // Define como data final (intervalo)
                    dateFilterInput.value = formattedDate;
                }
            }
            
            atualizarDisplayData();
            renderCalendar(); // Re-renderiza para mostrar o intervalo
            renderKanban();
            
            // Fecha o calend√°rio ap√≥s selecionar
            closeDatePicker();
        }

        // Fun√ß√£o para abrir o calend√°rio
        function openDatePicker() {
            const dateFilterInput = document.getElementById('date-filter');
            if (dateFilterInput.value) {
                const [year, month, day] = dateFilterInput.value.split('-');
                currentCalendarDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } else {
                currentCalendarDate = new Date();
            }
            renderCalendar();
            document.getElementById('date-picker-modal').classList.add('show');
        }

        // Fun√ß√£o para fechar o calend√°rio
        function closeDatePicker() {
            document.getElementById('date-picker-modal').classList.remove('show');
        }

        // Vari√°vel para o calend√°rio de custos
        let currentCalendarDateCustos = new Date();

        // Fun√ß√£o para renderizar o calend√°rio de custos
        function renderCalendarCustos() {
            const calendarGrid = document.getElementById('calendar-grid-custos');
            const monthYearDisplay = document.getElementById('month-year-display-custos');
            
            const year = currentCalendarDateCustos.getFullYear();
            const month = currentCalendarDateCustos.getMonth();
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            
            calendarGrid.innerHTML = '';
            
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'date-picker-weekday';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'date-picker-day other-month';
                calendarGrid.appendChild(emptyDay);
            }
            
            const hoje = new Date();
            const dateFilterInput = document.getElementById('date-filter-custos');
            const currentValue = dateFilterInput.value ? new Date(dateFilterInput.value + 'T00:00:00') : null;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'date-picker-day';
                dayElement.textContent = day;
                
                const cellDate = new Date(year, month, day);
                
                if (cellDate.toDateString() === hoje.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                if (currentValue && cellDate.toDateString() === currentValue.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                dayElement.addEventListener('click', () => {
                    selectDateCustos(year, month, day);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Fun√ß√£o para selecionar uma data nos custos
        function selectDateCustos(year, month, day) {
            const dateFilterInput = document.getElementById('date-filter-custos');
            const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dateFilterInput.value = formattedDate;
            
            const [y, m] = formattedDate.split('-');
            const dateFilterDisplay = document.getElementById('date-filter-custos-display');
            if (dateFilterDisplay) {
                dateFilterDisplay.value = `${m}/${y}`;
            }
            
            renderCustos();
            closeDatePickerCustos();
        }

        // Fun√ß√£o para abrir o calend√°rio de custos
        function openDatePickerCustos() {
            const dateFilterInput = document.getElementById('date-filter-custos');
            if (dateFilterInput.value) {
                const [year, month, day] = dateFilterInput.value.split('-');
                currentCalendarDateCustos = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } else {
                currentCalendarDateCustos = new Date();
            }
            renderCalendarCustos();
            document.getElementById('date-picker-modal-custos').classList.add('show');
        }

        // Fun√ß√£o para fechar o calend√°rio de custos
        function closeDatePickerCustos() {
            document.getElementById('date-picker-modal-custos').classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dateFilterInput = document.getElementById('date-filter');
            const dateFilterDisplay = document.getElementById('date-filter-display');
            
            // Define o filtro para o per√≠odo vigente (primeiro dia do m√™s atual - filtra por m√™s/ano)
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            // Usa dia 01 para indicar que √© filtro por m√™s/ano (n√£o por dia espec√≠fico)
            dateFilterInput.value = `${ano}-${mes}-01`;
            atualizarDisplayData();

            fetchPedidos();

            // Quando clicar no display, abre o calend√°rio customizado
            dateFilterDisplay.addEventListener('click', openDatePicker);
            
            // Bot√µes do calend√°rio
            document.getElementById('prev-month').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            document.getElementById('btn-limpar').addEventListener('click', () => {
                dateFilterInput.value = '';
                document.getElementById('date-filter-inicial').value = '';
                atualizarDisplayData();
                renderKanban();
                closeDatePicker();
            });
            
            document.getElementById('btn-hoje').addEventListener('click', () => {
                const hoje = new Date();
                const year = hoje.getFullYear();
                const month = String(hoje.getMonth() + 1).padStart(2, '0');
                const day = String(hoje.getDate()).padStart(2, '0');
                dateFilterInput.value = `${year}-${month}-${day}`;
                document.getElementById('date-filter-inicial').value = '';
                atualizarDisplayData();
                renderKanban();
                closeDatePicker();
            });
            
            document.getElementById('btn-mes-atual').addEventListener('click', () => {
                const hoje = new Date();
                const year = hoje.getFullYear();
                const month = String(hoje.getMonth() + 1).padStart(2, '0');
                // Define como primeiro dia do m√™s (filtro por m√™s/ano)
                dateFilterInput.value = `${year}-${month}-01`;
                document.getElementById('date-filter-inicial').value = '';
                atualizarDisplayData();
                renderKanban();
                closeDatePicker();
            });
            
            // Fechar calend√°rio ao clicar fora
            document.getElementById('date-picker-modal').addEventListener('click', (e) => {
                if (e.target.id === 'date-picker-modal') {
                    closeDatePicker();
                }
            });

            // Chama a renderiza√ß√£o/filtro toda vez que a busca √© alterada
            const searchFilterInput = document.getElementById('search-filter');
            searchFilterInput.addEventListener('input', renderKanban);
            
            // Event listeners para filtros de custos
            const searchFilterCustos = document.getElementById('search-filter-custos');
            if (searchFilterCustos) {
                searchFilterCustos.addEventListener('input', renderCustos);
            }
            
            const dateFilterCustos = document.getElementById('date-filter-custos');
            const dateFilterCustosDisplay = document.getElementById('date-filter-custos-display');
            if (dateFilterCustos && dateFilterCustosDisplay) {
                // Inicializa o display da data
                function atualizarDisplayDataCustos() {
                    const value = dateFilterCustos.value;
                    if (value) {
                        const [year, month] = value.split('-');
                        dateFilterCustosDisplay.value = `${month}/${year}`;
                    } else {
                        dateFilterCustosDisplay.value = '';
                    }
                }
                
                dateFilterCustos.addEventListener('change', () => {
                    atualizarDisplayDataCustos();
                    renderCustos();
                });
                
                dateFilterCustosDisplay.addEventListener('click', () => {
                    openDatePickerCustos();
                });
                
                // Bot√µes do calend√°rio de custos
                document.getElementById('prev-month-custos').addEventListener('click', () => {
                    currentCalendarDateCustos.setMonth(currentCalendarDateCustos.getMonth() - 1);
                    renderCalendarCustos();
                });
                
                document.getElementById('next-month-custos').addEventListener('click', () => {
                    currentCalendarDateCustos.setMonth(currentCalendarDateCustos.getMonth() + 1);
                    renderCalendarCustos();
                });
                
                document.getElementById('btn-limpar-custos').addEventListener('click', () => {
                    dateFilterCustos.value = '';
                    atualizarDisplayDataCustos();
                    renderCustos();
                    closeDatePickerCustos();
                });
                
                document.getElementById('btn-hoje-custos').addEventListener('click', () => {
                    const hoje = new Date();
                    const year = hoje.getFullYear();
                    const month = String(hoje.getMonth() + 1).padStart(2, '0');
                    const day = String(hoje.getDate()).padStart(2, '0');
                    dateFilterCustos.value = `${year}-${month}-${day}`;
                    atualizarDisplayDataCustos();
                    renderCustos();
                    closeDatePickerCustos();
                });
                
                document.getElementById('btn-mes-atual-custos').addEventListener('click', () => {
                    const hoje = new Date();
                    const year = hoje.getFullYear();
                    const month = String(hoje.getMonth() + 1).padStart(2, '0');
                    dateFilterCustos.value = `${year}-${month}-01`;
                    atualizarDisplayDataCustos();
                    renderCustos();
                    closeDatePickerCustos();
                });
                
                // Fechar calend√°rio de custos ao clicar fora
                document.getElementById('date-picker-modal-custos').addEventListener('click', (e) => {
                    if (e.target.id === 'date-picker-modal-custos') {
                        closeDatePickerCustos();
                    }
                });
                
                // Define o filtro para o per√≠odo vigente (primeiro dia do m√™s atual)
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                dateFilterCustos.value = `${ano}-${mes}-01`;
                atualizarDisplayDataCustos();
            } 
            
            // Atualiza√ß√£o autom√°tica a cada 15 segundos para sincroniza√ß√£o com a planilha
            // S√≥ executa se n√£o estiver em opera√ß√£o (isUpdating = false)
            setInterval(() => {
                if (!isUpdating) {
                    fetchPedidos();
                }
            }, 15000); 
            
            window.addEventListener('click', (event) => {
                // Fecha o modal ao clicar fora
                 if (event.target === modal) {
                     closeModal();
                 }
            });
              
            const calculatorModal = document.getElementById('calculator-modal');
            calculatorModal.addEventListener('click', closeCalculatorModal);
              
            // Inicializa op√ß√µes do modal de mover
            const bulkMoveSelect = document.getElementById('bulk-move-status');
            KANBAN_STATUSES.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                bulkMoveSelect.appendChild(option);
            });
              
        });

        // =========================================================================
        // FUN√á√ïES DE SELE√á√ÉO M√öLTIPLA E A√á√ïES EM LOTE
        // =========================================================================
        
        let selectedTickets = new Set();
        let currentSendType = null;

        function toggleTicketSelection(checkbox) {
            const pedidoId = checkbox.dataset.pedidoId;
            const card = checkbox.closest('.pedido-card');
            const column = card.closest('.kanban-column');
            
            if (checkbox.checked) {
                selectedTickets.add(pedidoId);
                card.classList.add('selected');
            } else {
                selectedTickets.delete(pedidoId);
                card.classList.remove('selected');
            }
            
            updateBulkActionsBar();
            
            // Atualiza o estado da checkbox do header da coluna
            if (column) {
                updateColumnCheckboxState(column);
            }
            
            // Atualiza o dashboard para mostrar total dos selecionados
            updateDashboardTotals([]);
        }

        function selectAllInColumn(columnElement) {
            // Encontra todos os checkboxes dentro desta coluna
            const checkboxes = columnElement.querySelectorAll('.card-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    // Marca o checkbox
                    checkbox.checked = true;
                    // Dispara o evento para atualizar a sele√ß√£o
                    toggleTicketSelection(checkbox);
                }
            });
            
            // Atualiza o estado da checkbox do header
            updateColumnCheckboxState(columnElement);
        }

        function deselectAllInColumn(columnElement) {
            // Encontra todos os checkboxes dentro desta coluna
            const checkboxes = columnElement.querySelectorAll('.card-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    // Desmarca o checkbox
                    checkbox.checked = false;
                    // Dispara o evento para atualizar a sele√ß√£o
                    toggleTicketSelection(checkbox);
                }
            });
            
            // Atualiza o estado da checkbox do header
            updateColumnCheckboxState(columnElement);
        }

        function updateColumnCheckboxState(columnElement) {
            const headerCheckbox = columnElement.querySelector('.column-select-all-checkbox');
            if (!headerCheckbox) return;
            
            const checkboxes = columnElement.querySelectorAll('.card-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const totalCount = checkboxes.length;
            
            if (totalCount === 0) {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = false;
            } else if (checkedCount === totalCount) {
                headerCheckbox.checked = true;
                headerCheckbox.indeterminate = false;
            } else if (checkedCount > 0) {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = true;
            } else {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = false;
            }
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulk-actions-bar');
            const count = document.getElementById('selected-count');
            
            if (selectedTickets.size > 0) {
                bar.classList.add('show');
                count.textContent = `${selectedTickets.size} selecionado${selectedTickets.size > 1 ? 's' : ''}`;
            } else {
                bar.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedTickets.clear();
            document.querySelectorAll('.card-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('.pedido-card').classList.remove('selected');
            });
            // Atualiza todas as checkboxes dos headers
            document.querySelectorAll('.kanban-column').forEach(column => {
                updateColumnCheckboxState(column);
            });
            updateBulkActionsBar();
            // Atualiza o dashboard para voltar ao total padr√£o
            renderKanban();
        }

        function showBulkMoveModal() {
            document.getElementById('bulk-move-modal').style.display = 'flex';
        }

        function closeBulkMoveModal() {
            document.getElementById('bulk-move-modal').style.display = 'none';
        }

        function showBulkPaymentModal() {
            document.getElementById('bulk-payment-modal').style.display = 'flex';
        }

        function closeBulkPaymentModal() {
            document.getElementById('bulk-payment-modal').style.display = 'none';
        }

        function showBulkSendModal() {
            document.getElementById('bulk-send-modal').style.display = 'flex';
            document.getElementById('send-destiny').style.display = 'none';
            currentSendType = null;
        }

        function closeBulkSendModal() {
            document.getElementById('bulk-send-modal').style.display = 'none';
            document.getElementById('send-destiny').style.display = 'none';
            currentSendType = null;
        }

        function selectSendType(type) {
            currentSendType = type;
            document.getElementById('send-destiny').style.display = 'block';
        }

        async function executeBulkMove() {
            const newStatus = document.getElementById('bulk-move-status').value;
            if (!newStatus) {
                showToast('Selecione uma etapa', true);
                return;
            }

            const statusNormalizado = normalizeStatus(newStatus);
            const promises = Array.from(selectedTickets).map(id => updatePedidoStatus(id, statusNormalizado));
            
            await Promise.all(promises);
            showToast(`${selectedTickets.size} ticket(s) movido(s)!`);
            clearSelection();
            closeBulkMoveModal();
        }

        async function executeBulkPayment() {
            const newStatus = document.getElementById('bulk-payment-status').value;
            if (!newStatus) {
                showToast('Selecione um status', true);
                return;
            }

            const promises = Array.from(selectedTickets).map(id => {
                const pedido = todosOsPedidos.find(p => p.ID_do_Pedido === id);
                if (pedido) {
                    pedido.Status_Pagamento = newStatus;
                    // Formata Total_Final com v√≠rgula decimal
                    const totalFormatado = String(pedido.Total_Final || '').replace('.', ',');
                    
                    const payload = {
                        action: 'updateData',
                        id: id,
                        ID_do_Pedido: id,
                        Nome_Cliente: pedido.Nome_Cliente || '',
                        Numero: pedido.Numero || '',
                        Data_Entrega: "'" + (pedido.Data_Entrega || ''), // Adiciona aspa simples para for√ßar texto
                        Horario_Entrega: "'" + (pedido.Horario_Entrega || ''), // Adiciona aspa simples para for√ßar texto
                        Total_Final: totalFormatado, // Com v√≠rgula decimal
                        Forma_de_Pagamento: pedido.Forma_de_Pagamento || '',
                        Status_Pagamento: newStatus,
                        Cupom: pedido.Cupom || '',
                        Resumo_dos_Itens: pedido.Resumo_dos_Itens || '',
                        Status_do_Pedido: pedido.Status_do_Pedido || ''
                    };
                    
                    // Adiciona Observacoes se existir
                    if (pedido.Observacoes !== undefined) {
                        payload.Observacoes = String(pedido.Observacoes || '');
                    }
                    
                    return addToQueue(payload);
                }
            });

            await Promise.all(promises);
            renderKanban();
            showToast(`${selectedTickets.size} ticket(s) atualizado(s)!`);
            clearSelection();
            closeBulkPaymentModal();
        }

        function sendToWhatsApp(destiny) {
            if (!currentSendType) {
                showToast('Selecione o tipo de encaminhamento primeiro', true);
                return;
            }

            const selectedPedidos = Array.from(selectedTickets).map(id => 
                todosOsPedidos.find(p => p.ID_do_Pedido === id)
            ).filter(p => p);

            const phoneNumbers = {
                'Arabela': '558199502865',
                'Favu': '558199591775'
            };

            const phone = phoneNumbers[destiny];
            let message = '';

            if (currentSendType === 'individual') {
                // Encaminhar individualmente
                message = `Resumo ${selectedPedidos.length} Pedido(s):\n\n`;
                
                selectedPedidos.forEach((pedido, index) => {
                    if (index > 0) message += '------------------------------------------\n\n';
                    
                    message += `*Pedido ${index + 1}*\n\n`;
                    message += `‚Ä¢ ${pedido.Nome_Cliente}\n`;
                    // Hor√°rio j√° vem limpo como string HH:mm do fetchPedidos - usa diretamente
                    const horaFormatada = pedido.Horario_Entrega || '00:00';
                    message += `   ‚§∑ ${pedido.Data_Entrega} √†s ${horaFormatada}\n`;
                    message += `   ‚§∑ ${pedido.ID_do_Pedido}\n\n`;
                    
                    // Processa itens por categoria
                    const resumo = extractResumoItens(pedido.Resumo_dos_Itens || '');
                    const itensPorCategoria = processarItensPorCategoria(resumo);
                    
                    message += `*Itens:*\n\n`;
                    
                    // Ordena as categorias e formata
                    const ordemCategorias = [
                        'Bolos Tradicionais',
                        'Bolos Especiais',
                        'Doces',
                        'Cookies',
                        'Salgados Fritos',
                        'Salgados Assados',
                        'Salgados Vegetarianos',
                        'Pratos Salgados'
                    ];
                    
                    ordemCategorias.forEach(categoria => {
                        const itens = itensPorCategoria[categoria];
                        if (itens.length > 0) {
                            message += `*- ${categoria}*\n`;
                            itens.forEach(item => {
                                message += ` ‚§∑ ${item}\n`;
                            });
                            message += `\n`;
                        }
                    });
                });
            } else {
                // Encaminhar resumo de itens
                const itensPorCategoria = {
                    'Bolos Tradicionais': {},
                    'Bolos Especiais': {},
                    'Doces': {},
                    'Cookies': {},
                    'Salgados Fritos': {},
                    'Salgados Assados': {},
                    'Salgados Vegetarianos': {},
                    'Pratos Salgados': {}
                };
                let totalGeral = 0;
                
                selectedPedidos.forEach(pedido => {
                    // Soma o total de cada pedido
                    totalGeral += parseFloat(pedido.Total_Final || 0);
                    
                    // Extrai o resumo dos itens
                    const resumo = extractResumoItens(pedido.Resumo_dos_Itens || '');
                    if (!resumo || resumo === 'N/A') return;
                    
                    // Processa o resumo completo para detectar categorias
                    const linhas = resumo.split('\n');
                    let categoriaAtual = '';
                    
                    linhas.forEach(linha => {
                        linha = linha.trim();
                        if (!linha) return;
                        
                        // Detecta categoria
                        if (linha.toLowerCase().includes('bolos tradicionais')) {
                            categoriaAtual = 'Bolos Tradicionais';
                            return;
                        } else if (linha.toLowerCase().includes('bolos especiais')) {
                            categoriaAtual = 'Bolos Especiais';
                            return;
                        } else if (linha.toLowerCase().includes('doces') && !linha.toLowerCase().includes('doce')) {
                            categoriaAtual = 'Doces';
                            return;
                        } else if (linha.toLowerCase().includes('cookies')) {
                            categoriaAtual = 'Cookies';
                            return;
                        } else if (linha.toLowerCase().includes('salgados fritos')) {
                            categoriaAtual = 'Salgados Fritos';
                            return;
                        } else if (linha.toLowerCase().includes('salgados assados')) {
                            categoriaAtual = 'Salgados Assados';
                            return;
                        } else if (linha.toLowerCase().includes('salgados vegetarianos')) {
                            categoriaAtual = 'Salgados Vegetarianos';
                            return;
                        } else if (linha.toLowerCase().includes('pratos salgados')) {
                            categoriaAtual = 'Pratos Salgados';
                            return;
                        }
                        
                        // Se n√£o tem categoria ou n√£o √© uma linha de item, pula
                        if (!categoriaAtual || !linha.includes('=')) return;
                        
                        let nomeItem = '';
                        let tamanhoPeso = '';
                        let qtd = 0;
                        let chave = '';
                        
                        // Padr√£o 1: Bolos com tamanho "Nome - Tamanho (Peso KG) - Qtd unidades"
                        let match = linha.match(/(.+?)\s*-\s*([PMG])\s*\(([\d.]+)\s*KG\)\s*-\s*(\d+)\s*unidades/i);
                        if (match) {
                            nomeItem = match[1].trim();
                            const tamanho = match[2];
                            const peso = match[3];
                            qtd = parseInt(match[4]);
                            tamanhoPeso = `${tamanho} (${peso} KG)`;
                            chave = `${nomeItem} - ${tamanhoPeso}`;
                        } else {
                            // Padr√£o 2: Cheesecake "Nome - Peso KG - Qtd unidades"
                            match = linha.match(/(.+?)\s*-\s*([\d.]+)\s*KG\s*-\s*(\d+)\s*unidades/i);
                            if (match) {
                                nomeItem = match[1].trim();
                                const peso = match[2];
                                qtd = parseInt(match[3]);
                                tamanhoPeso = `${peso} KG`;
                                chave = `${nomeItem} (${tamanhoPeso})`;
                            } else {
                                // Padr√£o 3: Doces/Salgados "Nome - Qtd unidades"
                                match = linha.match(/(\*?)(.+?)\s*-\s*(\d+)\s*unidades/i);
                                if (match) {
                                    const asterisco = match[1];
                                    nomeItem = (asterisco + match[2]).trim();
                                    qtd = parseInt(match[3]);
                                    chave = nomeItem;
                                } else {
                                    // Padr√£o 4: Fallback gen√©rico "Nome - Qtd un."
                                    match = linha.match(/(.+?)\s*-\s*(\d+)\s*un\./i);
                                    if (match) {
                                        nomeItem = match[1].trim();
                                        qtd = parseInt(match[2]);
                                        chave = nomeItem;
                                    }
                                }
                            }
                        }
                        
                        if (chave && qtd > 0 && categoriaAtual) {
                            if (itensPorCategoria[categoriaAtual][chave]) {
                                itensPorCategoria[categoriaAtual][chave] += qtd;
                            } else {
                                itensPorCategoria[categoriaAtual][chave] = qtd;
                            }
                        }
                    });
                });

                // Monta a mensagem
                message = `Resumo ${selectedPedidos.length} Pedido(s):\n\n`;
                message += `*- Clientes:*\n\n`;
                selectedPedidos.forEach(p => {
                    // Hor√°rio j√° vem limpo como string HH:mm do fetchPedidos - usa diretamente
                    const horaFormatada = p.Horario_Entrega || '00:00';
                    message += `‚Ä¢ ${p.Nome_Cliente}\n`;
                    message += `   ‚§∑ ${p.Data_Entrega} √†s ${horaFormatada}\n`;
                    message += `   ‚§∑ ${p.ID_do_Pedido}\n\n`;
                });
                message += `*- Itens:*\n\n`;
                
                // Ordena as categorias e formata
                const ordemCategorias = [
                    'Bolos Tradicionais',
                    'Bolos Especiais',
                    'Doces',
                    'Cookies',
                    'Salgados Fritos',
                    'Salgados Assados',
                    'Salgados Vegetarianos',
                    'Pratos Salgados'
                ];
                
                ordemCategorias.forEach(categoria => {
                    const itens = itensPorCategoria[categoria];
                    const itensKeys = Object.keys(itens);
                    
                    if (itensKeys.length > 0) {
                        message += `*- ${categoria}*\n`;
                        itensKeys.sort().forEach(item => {
                            const quantidade = itens[item];
                            message += `${quantidade} un. - ${item}\n`;
                        });
                        message += `\n`;
                    }
                });
                
                message += `Total Geral: R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
            }

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            showToast(`Encaminhando para ${destiny}...`);
            closeBulkSendModal();
            clearSelection();
        }
    </script>
    
    <div id="bulk-actions-bar">
        <span id="selected-count">0 selecionados</span>
        <button id="bulk-move-btn" onclick="showBulkMoveModal()">Etapa</button>
        <button id="bulk-payment-btn" onclick="showBulkPaymentModal()">Pagamento</button>
        <button id="bulk-send-btn" onclick="showBulkSendModal()">Encaminhar</button>
        <button onclick="clearSelection()" style="background-color: #e74c3c;">Limpar Sele√ß√£o</button>
    </div>

    <div id="bulk-move-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeBulkMoveModal()">&times;</span>
            <h2>Mover Tickets Selecionados</h2>
            <p>Selecione a etapa para mover os tickets:</p>
            <select id="bulk-move-status" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                <option value="">Selecione uma etapa...</option>
            </select>
            <div class="modal-actions">
                <button onclick="executeBulkMove()" style="background-color: #2ecc71;">Confirmar</button>
                <button onclick="closeBulkMoveModal()" style="background-color: #e74c3c;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="bulk-payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeBulkPaymentModal()">&times;</span>
            <h2>Atualizar Status de Pagamento</h2>
            <p>Selecione o status de pagamento para os tickets:</p>
            <select id="bulk-payment-status" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                <option value="Pendente">Pendente</option>
                <option value="Pago 50%">Pago 50%</option>
                <option value="Pago 100%">Pago 100%</option>
            </select>
            <div class="modal-actions">
                <button onclick="executeBulkPayment()" style="background-color: #2ecc71;">Confirmar</button>
                <button onclick="closeBulkPaymentModal()" style="background-color: #e74c3c;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="bulk-send-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeBulkSendModal()">&times;</span>
            <h2>Encaminhar Tickets</h2>
            <p>Escolha o tipo de encaminhamento:</p>
            <button onclick="selectSendType('individual')" style="width: 100%; padding: 15px; margin: 10px 0; background-color: #7FB1C8;">Encaminhar Individualmente</button>
            <button onclick="selectSendType('resumo')" style="width: 100%; padding: 15px; margin: 10px 0; background-color: #E09F41;">Encaminhar Resumo de Itens</button>
            <div id="send-destiny" style="display: none; margin-top: 20px;">
                <p>Escolha o destinat√°rio:</p>
                <button onclick="sendToWhatsApp('Arabela')" style="width: 100%; padding: 15px; margin: 10px 0; background-color: #2ecc71;">Arabela (558199502865)</button>
                <button onclick="sendToWhatsApp('Favu')" style="width: 100%; padding: 15px; margin: 10px 0; background-color: #2ecc71;">Favu (558199591775)</button>
            </div>
            <div class="modal-actions">
                <button onclick="closeBulkSendModal()" style="background-color: #e74c3c;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>
</body>
</html>
